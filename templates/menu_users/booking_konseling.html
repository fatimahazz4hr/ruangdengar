{% extends "base_user.html" %}
{% load static %}

{% block title %}Booking Konseling | Ruang Dengar{% endblock %}

{% block content %}

<style>

    .booking-header {
        background: linear-gradient(135deg, #e8e4ff 0%, #f0edff 100%);
        padding: 35px 40px;
        border-radius: 12px;
        margin-bottom: 35px;
    }

    .booking-title {
        font-size: 32px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 8px;
    }

    .booking-subtitle {
        font-size: 15px;
        color: #555;
        line-height: 1.5;
    }

    .psychologist-card {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        margin-bottom: 35px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .psychologist-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(135deg, #d4a257 0%, #c8963e 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        flex-shrink: 0;
    }

    .psychologist-avatar svg {
        width: 35px;
        height: 35px;
        color: #fff;
    }

    .psychologist-info h3 {
        font-size: 20px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 5px;
    }

    .psychologist-info p {
        font-size: 13px;
        color: #666;
        line-height: 1.5;
    }

    .form-section {
        background: #fff;
        padding: 35px 40px;
        border-radius: 12px;
        margin-bottom: 35px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .form-section-title {
        font-size: 22px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 25px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        color: #333;
        transition: border-color 0.3s;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #7b61ff;
    }

    .form-control-textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }

    .form-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 25px;
    }

    .btn {
        padding: 12px 28px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-cancel {
        background: #fff;
        color: #d32f2f;
        border: 2px solid #d32f2f;
    }

    .btn-cancel:hover {
        background: #d32f2f;
        color: #fff;
    }

    .btn-primary {
        background: #7b61ff;
        color: #fff;
    }

    .btn-primary:hover {
        background: #6849ff;
    }

    .schedule-section {
        background: #fff;
        padding: 35px 40px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .schedule-title {
        font-size: 22px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 25px;
    }

    .schedule-table {
        width: 100%;
        border-collapse: collapse;
    }

    .schedule-table thead {
        background: #f8f9fa;
    }

    .schedule-table th {
        padding: 15px 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #555;
        border-bottom: 2px solid #e0e0e0;
    }

    .schedule-table td {
        padding: 18px 12px;
        font-size: 14px;
        color: #333;
        border-bottom: 1px solid #f0f0f0;
    }

    .schedule-table tbody tr:hover {
        background: #fafafa;
    }

    .status-badge {
        padding: 5px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .status-terjadwal {
        background: #e3f2fd;
        color: #1976d2;
    }

    .status-selesai {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .status-dibatalkan {
        background: #ffebee;
        color: #c62828;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .psychologist-card {
            flex-direction: column;
            text-align: center;
        }

        .psychologist-avatar {
            margin-right: 0;
            margin-bottom: 15px;
        }

        .schedule-table {
            font-size: 12px;
        }

        .schedule-table th,
        .schedule-table td {
            padding: 10px 8px;
        }
    }
</style>

<div class="booking-container">

    <!-- Header Section -->
    <div class="booking-header">
        <h1 class="booking-title">Booking Konseling</h1>
        <p class="booking-subtitle">Lihat, atur, dan pesan jadwal sesi konseling Anda bersama Psikolog Kampus.</p>
    </div>

    <!-- Info Lokasi dan Kontak PPKS -->
    <div style="background: #fff; padding: 20px 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #5a509b; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#5a509b" viewBox="0 0 16 16">
                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    <strong style="color: #1a1a1a; font-size: 15px;">Lokasi Konseling</strong>
                </div>
                <p style="margin: 0; color: #555; font-size: 14px; margin-left: 30px;">
                    Ruang <strong style="color: #5a509b;">REK-407</strong><br>
                    <span style="font-size: 12px; color: #888;">*Lokasi dapat berubah, perhatikan catatan admin di jadwal Anda</span>
                </p>
            </div>
            <div style="flex: 1; min-width: 250px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#10b981" viewBox="0 0 16 16">
                        <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122l-2.19.547a1.745 1.745 0 0 1-1.657-.459L5.482 8.062a1.745 1.745 0 0 1-.46-1.657l.548-2.19a.678.678 0 0 0-.122-.58L3.654 1.328zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.678.678 0 0 0 .178.643l2.457 2.457a.678.678 0 0 0 .644.178l2.189-.547a1.745 1.745 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.634 18.634 0 0 1-7.01-4.42 18.634 18.634 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511z"/>
                    </svg>
                    <strong style="color: #1a1a1a; font-size: 15px;">Kontak PPKS</strong>
                </div>
                <p style="margin: 0; color: #555; font-size: 14px; margin-left: 30px;">
                    <a href="https://wa.me/6281323323677" target="_blank" style="color: #10b981; text-decoration: none; font-weight: 600; font-size: 16px;">0813-2332-3677</a><br>
                    <span style="font-size: 12px; color: #888;">Telkom University - Layanan PPKS 24/7</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Booking Form -->
    <div class="form-section">
        <h2 class="form-section-title">Form Booking Sesi</h2>

        <!-- Display Messages -->
        {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for message in messages %}
            <div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 10px; {% if message.tags == 'error' %}background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5;{% elif message.tags == 'success' %}background: #dcfce7; color: #16a34a; border: 1px solid #86efac;{% else %}background: #e0f2fe; color: #0284c7; border: 1px solid #7dd3fc;{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="POST" action="{% url 'booking-konseling' %}">
            {% csrf_token %}

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tanggal</label>
                    <input type="date" name="tanggal" class="form-control" id="tanggalInput" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Waktu</label>
                    <input type="time" name="waktu" class="form-control" value="10:00" required>
                </div>
            </div>
            <script>
                // Set tanggal default ke hari ini dan min ke hari ini
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('tanggalInput').value = today;
                document.getElementById('tanggalInput').min = today;
            </script>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Konselor</label>
                    <select name="konselor" class="form-control" required>
                        {% if counselors %}
                            {% for c in counselors %}
                                <option value="{{ c.id }}">{{ c.name }}{% if c.title %} - {{ c.title }}{% endif %}</option>
                            {% endfor %}
                        {% else %}
                            <option value="">Hasri Wulan Nugraheni, S.Psi</option>
                        {% endif %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nama</label>
                    <input type="text" name="nama" class="form-control" value="{{ nama_user }}" readonly style="background:#f5f5f5;cursor:not-allowed;" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Topik Konseling</label>
                <textarea name="topik" class="form-control form-control-textarea"
                    placeholder="Strategi mengatasi kecemasan" required></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Jenis Konseling</label>
                <select name="jenis" class="form-control" required>
                    <option value="">Pilih jenis konseling</option>
                    <option value="Kesehatan Mental">Kesehatan Mental</option>
                    <option value="Akademik & Studi">Akademik & Studi</option>
                    <option value="Hubungan Interpersonal">Hubungan Interpersonal</option>
                    <option value="Pelecehan dan Kekerasan Seksual">Pelecehan dan Kekerasan Seksual</option>
                    <option value="Karier & Pengembangan Diri">Karier & Pengembangan Diri</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>

            <div class="form-buttons">
                <button type="button" class="btn btn-cancel" onclick="window.history.back()">Batal</button>
                <button type="submit" class="btn btn-primary">Konfirmasi Booking</button>
            </div>
        </form>
    </div>

    <!-- Schedule Table -->
    <div class="schedule-section">
        <h2 class="schedule-title">Jadwal Konseling Anda</h2>

        <table class="schedule-table">
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>Waktu</th>
                    <th>Psikolog</th>
                    <th>Topik</th>
                    <th>Lokasi</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <!-- Debug: Total bookings = {{ bookings|length }} -->
                {% if bookings %}
                    {% for b in bookings %}
                        <tr>
                            <td>{{ b.tanggal }}</td>
                            <td>{{ b.waktu }}</td>
                            <td>{{ b.konselor }}</td>
                            <td>
                                <strong>{{ b.jenis }}</strong>
                                {% if b.catatan_admin %}
                                <div style="margin-top: 6px; padding: 8px 10px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 13px;">
                                    <strong style="color: #856404;">ðŸ’¬ Catatan Admin:</strong><br>
                                    <span style="color: #555;">{{ b.catatan_admin }}</span>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="#5a509b" viewBox="0 0 16 16">
                                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                                    </svg>
                                    <strong style="color: #5a509b;">{{ b.lokasi_konseling }}</strong>
                                </div>
                            </td>
                            <td>
                                {% if b.status == 'terjadwal' %}
                                    <span class="status-badge status-terjadwal">Terjadwal</span>
                                {% elif b.status == 'selesai' %}
                                    <span class="status-badge status-selesai">Selesai</span>
                                {% else %}
                                    <span class="status-badge status-dibatalkan">Dibatalkan</span>
                                    {% if b.alasan_pembatalan %}
                                        <br><small style="color:#666;font-style:italic;">Alasan: {{ b.alasan_pembatalan }}</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #999;">Belum ada jadwal konseling.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

</div>

{% endblock %}