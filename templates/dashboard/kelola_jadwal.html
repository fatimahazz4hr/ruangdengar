{% extends 'base.html' %} {% block title %}Kelola Jadwal Konseling{% endblock %}
{% block content %}
<style>
  body {
    font-family: "Inter", sans-serif;
    background-color: #f4f5f7;
    margin: 0;
  }
  .container-jadwal {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
    padding: 25px 30px;
    margin-top: 10px;
  }
  .header-jadwal {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }
  .header-jadwal h2 {
    color: #1f2937;
    font-size: 25px;
    font-weight: 700;
  }
  .btn-tambah {
    background: #5a509b;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    cursor: pointer;
    transition: 0.3s;
    font-weight: 500;
    margin-left: 20px;
  }
  .btn-tambah:hover {
    background: #473d8c;
  }
  .filter-section {
    margin-bottom: 30px;
    padding: 20px 25px;
    background: #fdfdff;
    border-radius: 12px;
    border: 2px solid #e0e0f0;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
  }
  .filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9e9f4;
  }
  .filter-header h3 {
    color: #5a509b;
    font-size: 16px;
    font-weight: 600;
  }
  .filter-options {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: flex-end;
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    min-width: 120px;
  }
  .filter-group label {
    font-size: 12px;
    color: #555;
    margin-bottom: 5px;
    font-weight: 500;
  }
  .filter-group input[type="date"],
  .filter-group select {
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 14px;
    color: #333;
    min-width: 100%;
    box-sizing: border-box;
    height: 40px;
  }
  .filter-group input[type="date"]:focus,
  .filter-group select:focus {
    border-color: #5a509b;
    outline: none;
  }
  .btn-filter,
  .btn-reset {
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    cursor: pointer;
    transition: 0.3s;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
    height: 40px;
    white-space: nowrap;
  }
  .btn-filter {
    background: #5a509b;
    color: #fff;
  }
  .btn-filter:hover {
    background: #473d8c;
  }
  .btn-reset {
    background: #f0f0f0;
    color: #555;
  }
  .btn-reset:hover {
    background: #e0e0e0;
  }
  .table-header-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-top: 10px;
  }
  .search-bar {
    position: relative;
  }
  .search-bar input[type="text"] {
    padding: 10px 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 14px;
    width: 250px;
    padding-left: 35px;
  }
  .search-bar::before {
    content: "üîç";
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #888;
    pointer-events: none;
  }
  .table-jadwal-container {
    margin-top: 10px;
  }
  .table-jadwal {
    width: 100%;
    border-collapse: collapse;
  }
  .table-jadwal th,
  .table-jadwal td {
    padding: 14px 12px;
    border-bottom: 1px solid #eee;
    text-align: left;
  }
  .table-jadwal th {
    background: #f2f0ff;
    color: #5a509b;
    font-weight: 600;
    font-size: 14px;
  }
  .table-jadwal td {
    background: #fff;
    color: #444;
    font-size: 14px;
  }
  .table-jadwal th:nth-child(5),
  .table-jadwal td:nth-child(5) {
    width: 18%;
  }
  .table-jadwal th:nth-child(6),
  .table-jadwal td:nth-child(6) {
    width: 18%;
  }
  .table-jadwal th:nth-child(7),
  .table-jadwal td:nth-child(7) {
    width: 12%;
  }
  .status-tag {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
  }
  .status-terjadwal {
    background: #e6f3ff;
    color: #1e88e5;
  }
  .status-dibatalkan {
    background: #ffebee;
    color: #d32f2f;
  }
  .status-selesai {
    background: #e8f5e9;
    color: #388e3c;
  }
  .action-btn {
    width: 34px;
    height: 34px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    font-size: 16px;
    transition: all 0.2s;
    margin: 0 3px;
  }
  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .action-btn.edit {
    border-color: #f59e0b;
  }
  .action-btn.edit:hover {
    background: #f59e0b;
    border-color: #f59e0b;
  }
  .action-btn.delete {
    border-color: #ef4444;
  }
  .action-btn.delete:hover {
    background: #ef4444;
    border-color: #ef4444;
  }
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    overflow-y: auto;
  }
  .modal-content {
    background: #fff;
    padding: 30px 40px;
    border-radius: 12px;
    width: 380px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    animation: fadeIn 0.3s ease-out;
  }
  .modal-content-edit {
    background: #fff;
    padding: 30px 40px;
    border-radius: 12px;
    width: 700px;
    max-width: 95%;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    animation: fadeIn 0.3s ease-out;
  }
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px 30px;
    margin-bottom: 20px;
  }
  .form-group {
    margin-bottom: 0;
    text-align: left;
  }
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #444;
    font-size: 14px;
  }
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 14px;
  }
  .form-group textarea {
    resize: vertical;
    min-height: 80px;
  }
  .form-actions-edit {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 30px;
  }
  .btn-batal,
  .btn-simpan {
    padding: 10px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    border: none;
  }
  .btn-batal {
    background: none;
    color: #555;
  }
  .btn-simpan {
    background: #5a509b;
    color: #fff;
  }
  .btn-simpan:hover {
    background: #473d8c;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<div class="container-jadwal">
  <div class="header-jadwal">
    <h2>Kelola Jadwal Konseling</h2>
  </div>

  <div class="filter-section">
    <div class="filter-header">
      <h3>üîé Filter Jadwal</h3>
      <button class="btn-tambah" onclick="showAddModal()">
        ‚ûï Tambah Jadwal
      </button>
    </div>
    <div class="filter-options">
      <div class="filter-group">
        <label>Dari Tanggal</label><input type="date" id="tanggalDari" />
      </div>
      <div class="filter-group">
        <label>Sampai Tanggal</label><input type="date" id="tanggalSampai" />
      </div>
      <div class="filter-group">
        <label>Konselor</label
        ><select id="konselor">
          <option value="semua">Semua Konselor</option>
          {% if counselors %}
            {% for c in counselors %}
              <option value="{{ c.id }}">{{ c.name }}{% if c.title %} - {{ c.title }}{% endif %}</option>
            {% endfor %}
          {% else %}
            <option>Dr. Indah Permata</option>
          {% endif %}
        </select>
      </div>
      <div class="filter-group">
        <label>Jenis</label
        ><select id="jenisKonselingFilter">
          <option value="semua">Semua Jenis</option>
          <option value="Kesehatan Mental">Kesehatan Mental</option>
          <option value="Akademik & Studi">Akademik & Studi</option>
          <option value="Hubungan Interpersonal">Hubungan Interpersonal</option>
          <option value="Kekerasan & Pelecehan">Kekerasan & Pelecehan</option>
          <option value="Karier & Pengembangan Diri">
            Karier & Pengembangan Diri
          </option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status</label
        ><select id="status">
          <option value="semua">Semua Status</option>
          <option value="Terjadwal">Terjadwal</option>
          <option value="Dibatalkan">Dibatalkan</option>
          <option value="Selesai">Selesai</option>
        </select>
      </div>
      <button class="btn-filter" onclick="applyFilter()">
        Terapkan Filter
      </button>
      <button class="btn-reset" onclick="resetFilter()">Reset</button>
    </div>
  </div>

  <div class="table-jadwal-container">
    <div class="table-header-controls">
      <div>
        <h3>Daftar Jadwal Konseling</h3>
        <p style="font-size: 13px; color: #777">
          Lihat, edit, atau hapus jadwal sesi konseling yang akan datang.
        </p>
      </div>
      <div class="search-bar">
        <input
          type="text"
          id="searchInput"
          onkeyup="searchTable()"
          placeholder="Cari Klien/Topik..."
        />
      </div>
    </div>

    <table class="table-jadwal" id="jadwalTable">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Waktu</th>
          <th>Konselor</th>
          <th>Klien</th>
          <th>Topik</th>
          <th>Jenis</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        {% if bookings %}
          {% for b in bookings %}
            <tr 
              data-lokasi="{{ b.lokasi_konseling }}" 
              data-catatan="{{ b.catatan_admin|default:'' }}"
              data-tanggal="{{ b.tanggal|date:'Y-m-d' }}"
              data-waktu="{{ b.waktu|time:'H:i' }}"
              data-konselor-id="{{ b.konselor_fk.id|default:'' }}"
            >
              <td>{{ b.tanggal }}</td>
              <td>{{ b.waktu }}</td>
              <td>{{ b.konselor }}</td>
              <td>{{ b.nama }}</td>
              <td>{{ b.topik }}</td>
              <td>{{ b.jenis }}</td>
              <td>
                <span class="status-tag {% if b.status == 'terjadwal' %}status-terjadwal{% elif b.status == 'selesai' %}status-selesai{% else %}status-dibatalkan{% endif %}">{{ b.status|capfirst }}</span>
              </td>
              <td>
                <button class="action-btn edit" onclick="showEditModal({{ b.id }})">‚úèÔ∏è</button>
                <button class="action-btn delete" onclick="showDeleteModal({{ b.id }})">üóëÔ∏è</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <!-- JS will populate if no backend-provided bookings -->
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Add/Edit -->
<div id="editModal" class="modal">
  <div class="modal-content-edit">
    <h3 id="modalTitle">Detail Konseling</h3>
    <p class="subtitle" id="modalSubtitle">
      Sesuaikan detail untuk janji temu konseling ini.
    </p>
    <form id="editForm">
      <input type="hidden" id="editId" name="id" />
      <div class="form-grid">
        <div class="form-group">
          <label>Tanggal</label><input type="date" id="editTanggal" required />
        </div>
        <div class="form-group">
          <label>Waktu</label
          ><input
            type="time"
            id="editWaktuDisplay"
            placeholder="HH:MM"
            required
          />
        </div>
        <div class="form-group">
          <label>Konselor</label
          ><select id="editKonselor" name="konselor">
            {% if counselors %}
              {% for c in counselors %}
                <option value="{{ c.id }}" data-name="{{ c.name }}">{{ c.name }}{% if c.title %} - {{ c.title }}{% endif %}</option>
              {% endfor %}
            {% else %}
              <option>Hasri Wulan Nugraheni, S.Psi</option>
            {% endif %}
          </select>
        </div>
        <div class="form-group" id="klienInputGroup">
          <label>Klien</label
          ><input type="text" id="editKlien" class="form-control" readonly style="background:#f5f5f5;cursor:not-allowed;" />
        </div>
        <div class="form-group" id="klienSelectGroup" style="display:none;">
          <label>Klien</label
          ><select id="editKlienSelect" class="form-control">
            <option value="">-- Pilih Mahasiswa --</option>
            {% for u in users %}
              <option value="{{ u.id }}" data-nama="{{ u.nama_lengkap }}">{{ u.nama_lengkap }}{% if u.email %} ({{ u.email }}){% endif %}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group full-width">
          <label>Topik Konseling</label
          ><textarea id="editTopik" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label>Status</label
          ><select id="editStatus">
            <option>Terjadwal</option>
            <option>Dibatalkan</option>
            <option>Selesai</option>
          </select>
        </div>
        <div class="form-group">
          <label>Jenis Konseling</label
          ><select id="editJenis">
            <option>Kesehatan Mental</option>
            <option>Akademik & Studi</option>
            <option>Hubungan Interpersonal</option>
            <option>Pelecehan dan Kekerasan Seksual</option>
            <option>Karier & Pengembangan Diri</option>
            <option>Lainnya</option>
          </select>
        </div>
        <div class="form-group">
          <label>Lokasi Konseling</label>
          <input type="text" id="editLokasi" class="form-control" value="REK-407" placeholder="REK-407">
        </div>
        <div class="form-group full-width">
          <label>Catatan untuk Mahasiswa (Opsional)</label>
          <textarea id="editCatatan" rows="2" placeholder="Contoh: Mohon datang 5 menit lebih awal, ruangan bisa berubah menjadi REK-408 jika ada konflik jadwal."></textarea>
        </div>
      </div>
      <div class="form-actions-edit">
        <button type="button" class="btn-batal" onclick="closeEditModal()">
          Batal
        </button>
        <button type="submit" class="btn-simpan">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Delete -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h3>Konfirmasi Hapus</h3>
    <p id="deleteText">Apakah Anda yakin ingin menghapus jadwal ini?</p>
    <div
      class="modal-actions"
      style="
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      "
    >
      <button class="btn-batal" onclick="closeDeleteModal()">Batal</button>
      <button class="btn-simpan" id="confirmDeleteBtn">Hapus</button>
    </div>
  </div>
</div>

<!-- Section: Tambah Konselor Baru -->
<div style="margin-top: 40px; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.05);">
  <h3 style="color: #1f2937; font-size: 20px; font-weight: 700; margin-bottom: 20px;">‚ûï Tambah Konselor Baru</h3>
  <form method="POST" action="{% url 'kelola-jadwal' %}" style="max-width: 600px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="add_counselor" />
    <div style="margin-bottom: 20px;">
      <label style="display:block; font-size:14px; font-weight:600; color:#333; margin-bottom:8px;">Nama Konselor</label>
      <input type="text" name="counselor_name" required style="width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px;" placeholder="Contoh: Hasri Wulan Nugraheni, S.Psi" />
    </div>
    <div style="margin-bottom: 20px;">
      <label style="display:block; font-size:14px; font-weight:600; color:#333; margin-bottom:8px;">Gelar / Spesialisasi (opsional)</label>
      <input type="text" name="counselor_title" style="width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px;" placeholder="Contoh: Psikolog Klinis" />
    </div>
    <button type="submit" style="background:#5a509b; color:#fff; border:none; border-radius:8px; padding:10px 20px; cursor:pointer; font-weight:600;">Tambah Konselor</button>
  </form>
  
  <!-- Daftar Konselor -->
  <div style="margin-top: 30px;">
    <h4 style="color: #1f2937; font-size: 16px; font-weight: 600; margin-bottom: 15px;">üìã Daftar Konselor</h4>
    <table style="width: 100%; border-collapse: collapse; background: #f9fafb; border-radius: 8px; overflow: hidden;">
      <thead>
        <tr style="background: #f3f4f6;">
          <th style="padding: 12px 15px; text-align: left; color: #6b7280; font-size: 13px; font-weight: 600;">Nama</th>
          <th style="padding: 12px 15px; text-align: left; color: #6b7280; font-size: 13px; font-weight: 600;">Gelar/Spesialisasi</th>
          <th style="padding: 12px 15px; text-align: center; color: #6b7280; font-size: 13px; font-weight: 600;">Aksi</th>
        </tr>
      </thead>
      <tbody>
        {% for c in counselors %}
        <tr style="border-bottom: 1px solid #e5e7eb;">
          <td style="padding: 12px 15px; color: #1f2937;">{{ c.name }}</td>
          <td style="padding: 12px 15px; color: #6b7280;">{{ c.title|default:"‚Äî" }}</td>
          <td style="padding: 12px 15px; text-align: center;">
            <button onclick="showEditCounselorModal({{ c.id }}, '{{ c.name|escapejs }}', '{{ c.title|escapejs }}')" class="action-btn edit" title="Edit">‚úèÔ∏è</button>
            <button onclick="showDeleteCounselorModal({{ c.id }}, '{{ c.name|escapejs }}')" class="action-btn delete" title="Hapus">üóëÔ∏è</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" style="padding: 20px; text-align: center; color: #9ca3af;">Belum ada konselor</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Edit Konselor -->
<div id="editCounselorModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; width:90%; max-width:500px;">
    <h3 style="margin-bottom:20px; color:#1f2937;">‚úèÔ∏è Edit Konselor</h3>
    <form id="editCounselorForm" method="POST">
      {% csrf_token %}
      <input type="hidden" id="editCounselorId" />
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; color:#374151; font-weight:600;">Nama Konselor</label>
        <input type="text" id="editCounselorName" name="counselor_name" required style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px;" />
      </div>
      <div style="margin-bottom:20px;">
        <label style="display:block; margin-bottom:5px; color:#374151; font-weight:600;">Gelar/Spesialisasi</label>
        <input type="text" id="editCounselorTitle" name="counselor_title" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px;" />
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button type="button" onclick="closeEditCounselorModal()" style="padding:10px 20px; background:#e5e7eb; border:none; border-radius:6px; cursor:pointer;">Batal</button>
        <button type="submit" style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Delete Konselor -->
<div id="deleteCounselorModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; width:90%; max-width:400px; text-align:center;">
    <h3 style="margin-bottom:15px; color:#1f2937;">‚ö†Ô∏è Hapus Konselor</h3>
    <p id="deleteCounselorText" style="color:#6b7280; margin-bottom:25px;"></p>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button onclick="closeDeleteCounselorModal()" style="padding:10px 20px; background:#e5e7eb; border:none; border-radius:6px; cursor:pointer;">Batal</button>
      <button id="confirmDeleteCounselorBtn" style="padding:10px 20px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Hapus</button>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  // No dummy data - only render backend data
  let schedules = [];

  function renderTable() {
    // Only render if schedules array is empty (meaning backend data not loaded yet)
    // Otherwise, let Django template render the data
    if (schedules.length === 0) return;
    
    const tbody = document.querySelector("#jadwalTable tbody");
    tbody.innerHTML = "";
    schedules.forEach((s) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${s.tanggal}</td><td>${s.waktu}</td><td>${
        s.konselor
      }</td><td>${s.klien}</td><td>${s.topik}</td><td>${
        s.jenis
      }</td><td><span class="status-tag ${
        s.status == "Terjadwal"
          ? "status-terjadwal"
          : s.status == "Selesai"
          ? "status-selesai"
          : "status-dibatalkan"
      }">${s.status}</span></td><td>
      <button class="action-btn edit" onclick="showEditModal(${
        s.id
      })">‚úèÔ∏è</button>
      <button class="action-btn delete" onclick="showDeleteModal(${
        s.id
      })">üóëÔ∏è</button>
    </td>`;
      tbody.appendChild(tr);
    });
  }

  function showAddModal() {
    document.getElementById("modalTitle").textContent =
      "‚ûï Tambah Jadwal Sesi Baru";
    document.getElementById("modalSubtitle").textContent =
      "Isi detail janji temu konseling yang baru.";
    document.getElementById("editId").value = "";
    document.getElementById("editTanggal").value = "";
    document.getElementById("editWaktuDisplay").value = "";
    document.getElementById("editTopik").value = "";
    document.getElementById("editStatus").value = "Terjadwal";
    document.getElementById("editJenis").value = "Kesehatan Mental";
    document.getElementById("editLokasi").value = "REK-407";
    document.getElementById("editCatatan").value = "";
    
    // Show dropdown for add mode, hide readonly input
    document.getElementById("klienInputGroup").style.display = "none";
    document.getElementById("klienSelectGroup").style.display = "block";
    document.getElementById("editKlienSelect").value = "";
    
    document.getElementById("editModal").style.display = "flex";
  }

  function showEditModal(id) {
    // Show readonly input for edit mode, hide dropdown
    document.getElementById("klienInputGroup").style.display = "block";
    document.getElementById("klienSelectGroup").style.display = "none";
    
    // First try to find in real table rows (from backend)
    const row = document.querySelector(`#jadwalTable tbody tr button[onclick*="showEditModal(${id})"]`);
    if (row) {
      const tr = row.closest('tr');
      const cells = tr.cells;
      const tanggalIso = tr.getAttribute('data-tanggal');
      const waktuIso = tr.getAttribute('data-waktu');
      document.getElementById("modalTitle").textContent = "‚úèÔ∏è Edit Jadwal Sesi";
      document.getElementById("modalSubtitle").textContent = "Ubah detail jadwal konseling.";
      document.getElementById("editId").value = id;
      document.getElementById("editTanggal").value = tanggalIso || cells[0].textContent.trim();
      document.getElementById("editWaktuDisplay").value = waktuIso || cells[1].textContent.trim();
      
      // Set konselor - prefer data attribute (id), fallback to matching text
      const konselorSelect = document.getElementById("editKonselor");
      const konselorId = tr.getAttribute('data-konselor-id');
      let konselorMatched = false;
      if (konselorId) {
        Array.from(konselorSelect.options).forEach(opt => {
          if (opt.value === konselorId) {
            opt.selected = true;
            konselorMatched = true;
          }
        });
      }
      if (!konselorMatched) {
        const konselorText = cells[2].textContent.trim();
        Array.from(konselorSelect.options).forEach(opt => {
          if (opt.textContent.trim() === konselorText || opt.value === konselorText) {
            opt.selected = true;
          }
        });
      }
      
      // cells[3] is Klien (NIM column removed)
      document.getElementById("editKlien").value = cells[3].textContent.trim();
      document.getElementById("editTopik").value = cells[4].textContent.trim();
      
      // Set jenis - find matching option
      const jenisText = cells[5].textContent.trim();
      const jenisSelect = document.getElementById("editJenis");
      Array.from(jenisSelect.options).forEach(opt => {
        if (opt.textContent.trim() === jenisText || opt.value === jenisText) {
          opt.selected = true;
        }
      });
      
      // Extract status from badge
      const statusBadge = cells[6].querySelector('.status-tag');
      if (statusBadge) {
        const statusText = statusBadge.textContent.trim();
        document.getElementById("editStatus").value = statusText;
      }
      
      // Load lokasi dan catatan dari data attributes
      const lokasi = tr.getAttribute('data-lokasi') || 'REK-407';
      const catatan = tr.getAttribute('data-catatan') || '';
      document.getElementById("editLokasi").value = lokasi;
      document.getElementById("editCatatan").value = catatan;
      
      document.getElementById("editModal").style.display = "flex";
      return;
    }
    
    // Fallback to JS mock data
    const s = schedules.find((x) => x.id === id);
    if (!s) return;
    document.getElementById("modalTitle").textContent = "‚úèÔ∏è Edit Jadwal Sesi";
    document.getElementById("modalSubtitle").textContent = "Ubah detail jadwal konseling.";
    document.getElementById("editId").value = s.id;
    document.getElementById("editTanggal").value = s.tanggal;
    document.getElementById("editWaktuDisplay").value = s.waktu;
    document.getElementById("editKonselor").value = s.konselor;
    document.getElementById("editKlien").value = s.klien;
    document.getElementById("editTopik").value = s.topik;
    document.getElementById("editStatus").value = s.status;
    document.getElementById("editJenis").value = s.jenis;
    document.getElementById("editModal").style.display = "flex";
  }

  function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
  }
  function showDeleteModal(id) {
    scheduleToDeleteId = id;
    document.getElementById("deleteModal").style.display = "flex";
  }
  function closeDeleteModal() {
    document.getElementById("deleteModal").style.display = "none";
  }

  document.getElementById("editForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const id = document.getElementById("editId").value;
    const konselorSelect = document.getElementById("editKonselor");
    
    // Check if add mode or edit mode
    if (!id) {
      // ADD MODE - POST to kelola-jadwal with action=add_booking
      const klienSelect = document.getElementById("editKlienSelect");
      const selectedUserId = klienSelect.value;
      
      if (!selectedUserId) {
        alert('Pilih mahasiswa terlebih dahulu.');
        return;
      }
      
      const formData = new FormData();
      formData.append('action', 'add_booking');
      formData.append('user_id', selectedUserId);
      formData.append('tanggal', document.getElementById("editTanggal").value);
      formData.append('waktu', document.getElementById("editWaktuDisplay").value);
      formData.append('konselor_id', konselorSelect.value);
      formData.append('topik', document.getElementById("editTopik").value);
      formData.append('jenis', document.getElementById("editJenis").value);
      formData.append('lokasi_konseling', document.getElementById("editLokasi").value || 'REK-407');
      formData.append('catatan_admin', document.getElementById("editCatatan").value || '');
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      // Debug log
      console.log('DEBUG Form submit:', {
        action: 'add_booking',
        user_id: selectedUserId,
        tanggal: document.getElementById("editTanggal").value,
        waktu: document.getElementById("editWaktuDisplay").value,
        konselor_id: konselorSelect.value,
        jenis: document.getElementById("editJenis").value
      });
      
      fetch('{% url "kelola-jadwal" %}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.redirected) {
          alert('‚úÖ Jadwal berhasil ditambahkan!');
          window.location.href = response.url;
        } else {
          return response.text().then(text => {
            throw new Error('Gagal menambahkan: ' + text);
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Terjadi kesalahan saat menambahkan jadwal.');
      });
    } else {
      // EDIT MODE - POST to edit endpoint
      const formData = new FormData();
      formData.append('tanggal', document.getElementById("editTanggal").value);
      formData.append('waktu', document.getElementById("editWaktuDisplay").value);
      formData.append('konselor_id', konselorSelect.value);
      formData.append('topik', document.getElementById("editTopik").value);
      formData.append('jenis', document.getElementById("editJenis").value);
      formData.append('status', document.getElementById("editStatus").value);
      formData.append('lokasi_konseling', document.getElementById("editLokasi").value || 'REK-407');
      formData.append('catatan_admin', document.getElementById("editCatatan").value || '');
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      fetch(`/dashboard/booking/${id}/edit/`, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.redirected) {
          alert('‚úÖ Perubahan berhasil disimpan!');
          window.location.href = response.url;
        } else {
          return response.text().then(text => {
            throw new Error('Gagal menyimpan: ' + text);
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Terjadi kesalahan saat menyimpan perubahan.');
      });
    }
  });

  document
    .getElementById("confirmDeleteBtn")
    .addEventListener("click", function () {
      // Delete via backend
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      fetch(`/dashboard/booking/${scheduleToDeleteId}/delete/`, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.redirected) {
          alert('‚úÖ Jadwal berhasil dihapus!');
          window.location.href = response.url;
        } else {
          return response.text().then(text => {
            throw new Error('Gagal menghapus: ' + text);
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Terjadi kesalahan saat menghapus jadwal.');
      });
      
      closeDeleteModal();
    });

  function searchTable() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const trs = document.querySelectorAll("#jadwalTable tbody tr");
    trs.forEach((tr) => {
      tr.style.display = Array.from(tr.cells).some((td) =>
        td.textContent.toLowerCase().includes(input)
      )
        ? ""
        : "none";
    });
  }

  function applyFilter() {
    alert("Fitur filter bisa dikodekan sesuai backend.");
  }
  function resetFilter() {
    document.getElementById("tanggalDari").value = "";
    document.getElementById("tanggalSampai").value = "";
    document.getElementById("konselor").value = "semua";
    document.getElementById("jenisKonselingFilter").value = "semua";
    document.getElementById("status").value = "semua";
    applyFilter();
  }

  // Only render from JS if no backend data was provided
  const tbody = document.querySelector("#jadwalTable tbody");
  if (!tbody || tbody.children.length === 0 || (tbody.children.length === 1 && tbody.textContent.includes('JS will populate'))) {
    renderTable();
  }

  // Counselor management
  let counselorToDeleteId = null;

  function showEditCounselorModal(id, name, title) {
    document.getElementById('editCounselorId').value = id;
    document.getElementById('editCounselorName').value = name;
    document.getElementById('editCounselorTitle').value = title || '';
    document.getElementById('editCounselorModal').style.display = 'flex';
  }

  function closeEditCounselorModal() {
    document.getElementById('editCounselorModal').style.display = 'none';
  }

  function showDeleteCounselorModal(id, name) {
    counselorToDeleteId = id;
    document.getElementById('deleteCounselorText').textContent = `Apakah Anda yakin ingin menghapus konselor "${name}"?`;
    document.getElementById('deleteCounselorModal').style.display = 'flex';
  }

  function closeDeleteCounselorModal() {
    document.getElementById('deleteCounselorModal').style.display = 'none';
    counselorToDeleteId = null;
  }

  // Handle edit counselor form submit
  document.getElementById('editCounselorForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const counselorId = document.getElementById('editCounselorId').value;
    const formData = new FormData(this);
    
    fetch(`/dashboard/counselor/${counselorId}/edit/`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.redirected) {
        alert('‚úÖ Konselor berhasil diperbarui!');
        window.location.href = response.url;
      } else {
        return response.text().then(text => {
          throw new Error('Gagal memperbarui: ' + text);
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('‚ùå Terjadi kesalahan saat memperbarui konselor.');
    });
  });

  // Handle delete counselor
  document.getElementById('confirmDeleteCounselorBtn').addEventListener('click', function() {
    if (!counselorToDeleteId) {
      console.error('No counselor ID to delete');
      return;
    }
    
    console.log('Deleting counselor ID:', counselorToDeleteId);
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/dashboard/counselor/${counselorToDeleteId}/delete/`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      console.log('Response status:', response.status);
      if (response.redirected) {
        window.location.href = response.url;
      } else {
        return response.text().then(text => {
          console.error('Response text:', text);
          // Check if it's an error message from Django
          if (text.includes('masih memiliki') || text.includes('booking')) {
            alert('‚ùå ' + text);
          } else {
            throw new Error('Gagal menghapus: ' + text);
          }
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('‚ùå Terjadi kesalahan saat menghapus konselor.');
    })
    .finally(() => {
      closeDeleteCounselorModal();
    });
  });
</script>
{% endblock %}
