{% extends 'base.html' %}

{% block title %}lihat-jadwal{% endblock %}

{% block content %}
<style>
  :root {
    --primary-color: #5d55f3; /* Ungu Utama */
    --active-bg: #eae8ff;
    --sidebar-width: 250px;
    --light-bg: #f4f7f6; /* Latar belakang halaman */
    --white: #ffffff;
    --text-dark: #333;
    --text-light: #777;
    --border-color: #e0e0e0;
    --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    --sidebar-text-color: #4a5568;
  }

  /* Catatan: Styling global seperti body, app-container, sidebar, header, dan footer
       seharusnya berada di base.html atau file CSS eksternal. 
       Saya menyertakannya di sini agar kode ini tetap utuh dan dapat dicoba secara mandiri. */

  /* --- LIHAT JADWAL SPECIFIC STYLING --- */
  .content-wrapper {
    padding: 30px;
    flex-grow: 1;
  }
  .page-title {
    font-size: 1.8em;
    margin-bottom: 20px;
    font-weight: bold;
  }
  .card {
    background-color: var(--white);
    padding: 20px;
    border-radius: 10px;
    box-shadow: var(--card-shadow);
  }

  /* Detail Sesi */
  .detail-card {
    margin-bottom: 20px;
  }
  .detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px 30px;
    margin-bottom: 20px;
    font-size: 0.95em;
  }
  .detail-grid p strong {
    color: var(--text-dark);
    font-weight: bold;
    margin-right: 5px;
  }

  .catatan .title {
    font-weight: bold;
    margin-bottom: 8px;
  }
  .note {
    background-color: var(--light-bg);
    padding: 15px;
    border-left: 3px solid var(--primary-color);
    border-radius: 4px;
    font-style: italic;
    color: var(--text-dark);
  }
  .actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
  }

  /* Button Styling */
  .btn {
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    border: 1px solid;
    transition: background-color 0.2s;
  }
  /* Tombol Batalkan Sesi (ungu/primer) */
  .btn.purple {
    background-color: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
  }
  .btn.purple:hover {
    background-color: #4941d3;
  }

  /* Tabel Jadwal */
  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  .table-header input {
    padding: 8px 15px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    width: 300px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }
  table th,
  table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.9em;
  }
  table th {
    color: var(--text-light);
    font-weight: 600;
    text-transform: uppercase;
  }
  /* Style baris yang dapat diklik */
  table tbody tr {
    cursor: pointer;
  }
  table tbody tr:hover {
    background-color: #f0f4f7;
  }
  table tbody tr.selected {
    background-color: var(--active-bg);
    border-left: 4px solid var(--primary-color);
  }

  /* Status Badge Tabel Jadwal */
  .status-badge-blue {
    background-color: #4299e1;
  } /* Terjadwal */
  .status-badge-green {
    background-color: #48bb78;
  } /* Selesai */
  .status-badge-red {
    background-color: #f56565;
  } /* Dibatalkan */
  .status-badge-yellow {
    background-color: #ffc107;
  } /* Sedang Berlangsung */
  .status-badge {
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.75em;
    font-weight: bold;
    color: var(--white);
    text-align: center;
    display: inline-block;
  }
</style>

<div class="content-wrapper">
  <div id="lihat-jadwal-content" class="page-content active">
    <h1 class="page-title">Lihat Jadwal Konseling</h1>

    <section class="card detail-card">
      <h3>Detail Sesi Konseling</h3>
      <div id="detail-grid" class="detail-grid">
        <p><strong>Tanggal:</strong> 2024-07-20</p>
        <p><strong>Waktu:</strong> 10:00 AM</p>
        <p><strong>Konselor:</strong> Dr. Sarah Cahyani</p>
        <p><strong>Klien:</strong> Budi Santoso</p>
        <p><strong>Topik:</strong> Manajemen Stres dan Kecemasan</p>
        <p><strong>Durasi:</strong> 60 menit</p>
        <p><strong>Jenis Konseling:</strong> Bullying</p>
        <p id="detail-status-wrapper">
          <strong>Status:</strong>
          <span id="detail-status" class="status-badge status-badge-yellow"
            >Berlangsung</span
          >
        </p>
      </div>

      <div class="catatan">
        <p class="title">Catatan Sesi:</p>
        <div id="detail-note" class="note">
          Klien telah mengikuti 3 sesi sebelumnya. Memiliki riwayat kecemasan
          ringan dan mencari teknik relaksasi yang efektif. Penting untuk
          menindaklanjuti strategi coping yang didiskusikan dalam sesi terakhir.
        </div>
      </div>

      <div class="actions">
        <button id="rekam-medis-btn" class="btn" style="background:#3b82f6;border-color:#3b82f6;margin-right:10px;">
          ðŸ©º Rekam Medis
        </button>
        <button id="complete-session-btn" class="btn" style="background:#10b981;border-color:#10b981;margin-right:10px;">
          Tandai Selesai
        </button>
        <button id="cancel-session-btn" class="btn purple">
          Batalkan Sesi
        </button>
      </div>
    </section>

    <section class="card">
      <div class="table-header">
        <h3>Daftar Jadwal Konseling</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
          <select id="sortFilter" onchange="sortSchedule()" style="padding: 8px 15px; border: 1px solid var(--border-color); border-radius: 6px;">
            <option value="asc">Tanggal (Terlama)</option>
            <option value="desc" selected>Tanggal (Terbaru)</option>
          </select>
          <input type="text" id="searchInput" placeholder="Cari jadwal..." onkeyup="filterSchedule()" style="padding: 8px 15px; border: 1px solid var(--border-color); border-radius: 6px; width: 300px;" />
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Waktu</th>
            <th>Konselor</th>
            <th>Klien</th>
            <th>Topik</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="schedule-body">
          {% if bookings %}
            {% for b in bookings %}
              <tr id="session-{{ b.id }}" class="schedule-row"
                  data-booking-id="{{ b.id }}"
                  data-tanggal="{{ b.tanggal }}"
                  data-waktu="{{ b.waktu }}"
                  data-konselor="{{ b.konselor }}"
                  data-klien="{{ b.nama }}"
                  data-topik="{{ b.topik|default:'' }}"
                  data-durasi="60 menit"
                  data-jenis="{{ b.jenis }}"
                  data-status="{{ b.status|capfirst }}"
                  data-note="{{ b.topik|default:'' }}"
                  data-alasan-pembatalan="{{ b.alasan_pembatalan|default:'' }}"
                  data-badge-class="{% if b.status == 'terjadwal' %}status-badge-blue{% elif b.status == 'selesai' %}status-badge-green{% else %}status-badge-red{% endif %}">
                <td>{{ b.tanggal }}</td>
                <td>{{ b.waktu }}</td>
                <td>{{ b.konselor }}</td>
                <td>{{ b.nama }}</td>
                <td>{{ b.topik }}</td>
                <td id="status-{{ b.id }}">
                  <span class="status-badge {% if b.status == 'terjadwal' %}status-badge-blue{% elif b.status == 'selesai' %}status-badge-green{% else %}status-badge-red{% endif %}">{{ b.status|capfirst }}</span>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6">Belum ada jadwal.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </section>
  </div>
</div>

<!-- Modal Pembatalan -->
<div id="cancelModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
  <div style="background:#fff;padding:30px;border-radius:12px;max-width:500px;width:90%;">
    <h3 style="margin-top:0;color:#333;">Batalkan Sesi Konseling</h3>
    <p style="color:#666;margin-bottom:20px;">Silakan masukkan alasan pembatalan:</p>
    <form id="cancelForm" method="POST">
      {% csrf_token %}
      <input type="hidden" id="cancelBookingId" name="booking_id" />
      <textarea id="alasanPembatalan" name="alasan_pembatalan" rows="4" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-family:inherit;resize:vertical;" placeholder="Contoh: Konselor berhalangan hadir karena sakit" required></textarea>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
        <button type="button" onclick="closeCancelModal()" style="padding:10px 20px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;">Batal</button>
        <button type="submit" style="padding:10px 20px;border:none;background:#5d55f3;color:#fff;border-radius:8px;cursor:pointer;font-weight:500;">Konfirmasi Pembatalan</button>
      </div>
    </form>
  </div>
</div>

<script>
  function closeCancelModal() {
    document.getElementById('cancelModal').style.display = 'none';
    document.getElementById('alasanPembatalan').value = '';
  }

  document.addEventListener("DOMContentLoaded", function () {
    const tableRows = document.querySelectorAll(".schedule-row");
    const detailGrid = document.getElementById("detail-grid");
    const detailNote = document.getElementById("detail-note");
    const detailStatusWrapper = document.getElementById(
      "detail-status-wrapper"
    );
    const cancelButton = document.getElementById("cancel-session-btn");

    // Variabel global untuk melacak sesi yang sedang dipilih
    let selectedRow = document.querySelector(".schedule-row.selected");

    // Fungsi untuk memperbarui detail sesi
    function updateDetail(row) {
      // Hapus class 'selected' dari semua baris dan atur baris baru
      tableRows.forEach((r) => r.classList.remove("selected"));
      row.classList.add("selected");
      selectedRow = row; // Perbarui sesi yang sedang aktif

      // 1. Ambil data dari data-attributes
      const data = {
        tanggal: row.dataset.tanggal,
        waktu: row.dataset.waktu,
        konselor: row.dataset.konselor,
        klien: row.dataset.klien,
        topik: row.dataset.topik,
        durasi: row.dataset.durasi,
        jenis: row.dataset.jenis,
        status: row.dataset.status,
        note: row.dataset.note,
        badgeClass: row.dataset.badgeClass,
      };

      // 2. Update Detail Grid
      detailGrid.innerHTML = `
                <p><strong>Tanggal:</strong> ${data.tanggal}</p>
                <p><strong>Waktu:</strong> ${data.waktu}</p>
                <p><strong>Konselor:</strong> ${data.konselor}</p>
                <p><strong>Klien:</strong> ${data.klien}</p>
                <p><strong>Topik:</strong> ${data.topik}</p>
                <p><strong>Durasi:</strong> ${data.durasi}</p>
                <p><strong>Jenis Konseling:</strong> ${data.jenis}</p>
            `;

      // 3. Update Status
      detailStatusWrapper.innerHTML = `
                <strong>Status:</strong>
                <span id="detail-status" class="status-badge ${data.badgeClass}">${data.status}</span>
            `;
      detailGrid.appendChild(detailStatusWrapper); // Tambahkan kembali ke grid

      // 4. Update Catatan - tampilkan alasan pembatalan jika ada
      if (data.status === "Dibatalkan" && row.dataset.alasanPembatalan) {
        detailNote.textContent = "Alasan Pembatalan: " + row.dataset.alasanPembatalan;
      } else {
        detailNote.textContent = data.note;
      }

      // 5. Atur tampilan tombol Batalkan dan Selesai
      const completeButton = document.getElementById("complete-session-btn");
      
      if (data.status === "Selesai" || data.status === "Dibatalkan") {
        cancelButton.disabled = true;
        cancelButton.textContent = `Sesi Sudah ${data.status}`;
        cancelButton.classList.remove("purple");
        cancelButton.style.backgroundColor = "#ccc";
        cancelButton.style.borderColor = "#ccc";
        cancelButton.style.cursor = "not-allowed";
        
        completeButton.disabled = true;
        completeButton.style.backgroundColor = "#ccc";
        completeButton.style.borderColor = "#ccc";
        completeButton.style.cursor = "not-allowed";
      } else {
        cancelButton.disabled = false;
        cancelButton.textContent = `Batalkan Sesi`;
        cancelButton.classList.add("purple");
        cancelButton.style.backgroundColor = "";
        cancelButton.style.borderColor = "";
        cancelButton.style.cursor = "pointer";
        
        completeButton.disabled = false;
        completeButton.style.backgroundColor = "#10b981";
        completeButton.style.borderColor = "#10b981";
        completeButton.style.cursor = "pointer";
      }
    }

    // Fungsi Pembatalan Sesi - Buka Modal
    function cancelSession() {
      if (!selectedRow) {
        alert("Pilih sesi yang ingin dibatalkan terlebih dahulu.");
        return;
      }

      const currentStatus = selectedRow.dataset.status;
      if (currentStatus === "Selesai" || currentStatus === "Dibatalkan") {
        alert(
          `Sesi ini sudah berstatus: ${currentStatus}. Pembatalan tidak dapat dilakukan.`
        );
        return;
      }

      // Set booking ID ke form
      const bookingId = selectedRow.dataset.bookingId;
      document.getElementById('cancelBookingId').value = bookingId;
      
      // Tampilkan modal
      document.getElementById('cancelModal').style.display = 'flex';
    }

    // Handle form submit
    document.getElementById('cancelForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const bookingId = document.getElementById('cancelBookingId').value;
      const alasan = document.getElementById('alasanPembatalan').value.trim();
      
      if (!alasan) {
        alert('Alasan pembatalan harus diisi.');
        return;
      }
      
      const formData = new FormData();
      formData.append('alasan_pembatalan', alasan);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      fetch(`/dashboard/booking/${bookingId}/cancel/`, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
        } else {
          return response.text().then(text => {
            throw new Error('Gagal membatalkan: ' + text);
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('âŒ Terjadi kesalahan saat membatalkan booking.');
      });
    });

    // Fungsi Tandai Selesai
    function completeSession() {
      if (!selectedRow) {
        alert("Pilih sesi yang ingin ditandai selesai terlebih dahulu.");
        return;
      }

      const currentStatus = selectedRow.dataset.status;
      if (currentStatus === "Selesai" || currentStatus === "Dibatalkan") {
        alert(
          `Sesi ini sudah berstatus: ${currentStatus}.`
        );
        return;
      }

      // Konfirmasi
      const confirmation = confirm(
        `Tandai sesi dengan klien ${selectedRow.dataset.klien} (${selectedRow.dataset.tanggal}) sebagai selesai?`
      );

      if (confirmation) {
        const bookingId = selectedRow.dataset.bookingId;
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch(`/dashboard/booking/${bookingId}/complete/`, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.redirected) {
            window.location.href = response.url;
          } else {
            return response.text().then(text => {
              throw new Error('Gagal menandai selesai: ' + text);
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('âŒ Terjadi kesalahan saat menandai booking selesai.');
        });
      }
    }

    // Inisialisasi Event Listeners

    // A. Event listener untuk tabel (memilih sesi)
    tableRows.forEach((row) => {
      row.addEventListener("click", function () {
        updateDetail(this);
      });
    });

    // B. Event listener untuk tombol Batalkan Sesi
    cancelButton.addEventListener("click", cancelSession);

    // C. Event listener untuk tombol Tandai Selesai
    const completeButton = document.getElementById("complete-session-btn");
    completeButton.addEventListener("click", completeSession);

    // D. Event listener untuk tombol Rekam Medis
    const rekamMedisButton = document.getElementById("rekam-medis-btn");
    rekamMedisButton.addEventListener("click", function() {
      if (!selectedRow) {
        alert("Pilih sesi yang ingin dilihat rekam medisnya terlebih dahulu.");
        return;
      }
      const bookingId = selectedRow.dataset.bookingId;
      window.location.href = `/dashboard/booking/${bookingId}/rekam-medis/`;
    });

    // D. Inisialisasi: Pastikan detail sesi pertama yang terpilih terisi saat dimuat
    if (selectedRow) {
      updateDetail(selectedRow);
    }
  });

  // Fungsi Sort Jadwal berdasarkan Tanggal
  function sortSchedule() {
    const sortValue = document.getElementById('sortFilter').value;
    const tbody = document.getElementById('schedule-body');
    const rows = Array.from(tbody.querySelectorAll('tr.schedule-row'));
    
    rows.sort((a, b) => {
      const dateA = new Date(a.dataset.tanggal);
      const dateB = new Date(b.dataset.tanggal);
      
      if (sortValue === 'asc') {
        return dateA - dateB; // Terlama ke Terbaru
      } else {
        return dateB - dateA; // Terbaru ke Terlama
      }
    });
    
    // Kosongkan tbody dan tambahkan row yang sudah terurut
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Re-attach event listeners setelah sort
    document.querySelectorAll('.schedule-row').forEach(row => {
      row.addEventListener('click', function() {
        const detailGrid = document.getElementById("detail-grid");
        const detailNote = document.getElementById("detail-note");
        
        document.querySelectorAll('.schedule-row').forEach(r => r.classList.remove('selected'));
        this.classList.add('selected');
        
        const data = {
          tanggal: this.dataset.tanggal,
          waktu: this.dataset.waktu,
          konselor: this.dataset.konselor,
          klien: this.dataset.klien,
          topik: this.dataset.topik,
          durasi: this.dataset.durasi,
          jenis: this.dataset.jenis,
          status: this.dataset.status,
          note: this.dataset.note,
          badgeClass: this.dataset.badgeClass
        };
        
        detailGrid.innerHTML = `
          <p><strong>Tanggal:</strong> ${data.tanggal}</p>
          <p><strong>Waktu:</strong> ${data.waktu}</p>
          <p><strong>Konselor:</strong> ${data.konselor}</p>
          <p><strong>Klien:</strong> ${data.klien}</p>
          <p><strong>Topik:</strong> ${data.topik}</p>
          <p><strong>Durasi:</strong> ${data.durasi}</p>
          <p><strong>Jenis Konseling:</strong> ${data.jenis}</p>
          <p id="detail-status-wrapper">
            <strong>Status:</strong>
            <span id="detail-status" class="status-badge ${data.badgeClass}">${data.status}</span>
          </p>
        `;
        detailNote.textContent = data.note || 'Tidak ada catatan';
      });
    });
  }
  
  // Fungsi Filter/Search Jadwal
  function filterSchedule() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('.schedule-row');
    
    rows.forEach(row => {
      const tanggal = row.dataset.tanggal.toLowerCase();
      const konselor = row.dataset.konselor.toLowerCase();
      const klien = row.dataset.klien.toLowerCase();
      const topik = row.dataset.topik.toLowerCase();
      const status = row.dataset.status.toLowerCase();
      
      if (tanggal.includes(searchValue) || 
          konselor.includes(searchValue) || 
          klien.includes(searchValue) || 
          topik.includes(searchValue) ||
          status.includes(searchValue)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }
</script>
{% endblock %}
