{% extends 'base.html' %} {% load static %} {% block title %}Kelola Laporan
{%endblock %} {% block content %}
<style>
  body {
    font-family: "Poppins", sans-serif;
    background: #f9fafb;
    margin: 0;
    padding: 0;
  }
  .report-container {
    padding: 30px;
  }
  .report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }
  .report-header h1 {
    font-size: 26px;
    color: #1f2937;
  }
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    background: #fff;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
  }
  .filter-bar select,
  .filter-bar input[type="search"] {
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    flex-grow: 1;
    max-width: 200px;
  }
  .filter-bar button {
    background-color: #5a509b;
    color: #fff;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.3s;
  }
  .filter-bar button:hover {
    background-color: #4338ca;
  }
  .report-table-section {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    overflow-x: auto;
  }
  .report-table {
    width: 100%;
    border-collapse: collapse;
  }
  .report-table th,
  .report-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #f3f4f6;
    text-align: left;
  }
  .report-table th {
    background: #eef2ff;
    color: #4f46e5;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
  }
  .status-badge {
    padding: 5px 10px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }
  .status-selesai {
    background-color: #d1fae5;
    color: #065f46;
  }
  .status-terjadwal {
    background-color: #fef3c7;
    color: #b45309;
  }
  .status-dibatalkan {
    background-color: #fee2e2;
    color: #991b1b;
  }
  .urgency-badge {
    padding: 4px 8px;
    border-radius: 9999px;
    font-size: 11px;
    font-weight: 700;
    display: inline-block;
    margin-right: 5px;
  }
  .urgency-darurat {
    background-color: #fee2e2;
    color: #991b1b;
    animation: pulse 1.5s ease-in-out infinite;
  }
  .urgency-tinggi {
    background-color: #fed7aa;
    color: #9a3412;
  }
  .urgency-sedang {
    background-color: #fef3c7;
    color: #92400e;
  }
  .urgency-rendah {
    background-color: #dbeafe;
    color: #1e40af;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
  .ai-kategori {
    font-size: 11px;
    color: #6b7280;
    font-style: italic;
  }
  .action-buttons {
    display: flex;
    gap: 6px;
  }
  .action-buttons a,
  .action-buttons button {
    width: 34px;
    height: 34px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    font-size: 16px;
    transition: all 0.2s;
    text-decoration: none;
  }
  .action-buttons a:hover,
  .action-buttons button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .btn-view {
    border-color: #5a509b;
  }
  .btn-view:hover {
    background: #5a509b;
    border-color: #5a509b;
  }
  .btn-edit {
    border-color: #f59e0b;
  }
  .btn-edit:hover {
    background: #f59e0b;
    border-color: #f59e0b;
  }
  .btn-delete {
    border-color: #ef4444;
  }
  .btn-delete:hover {
    background: #ef4444;
    border-color: #ef4444;
  }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    justify-content: center;
    align-items: center;
  }
  .modal {
    background: #fff;
    border-radius: 12px;
    width: 700px;
    max-width: 95%;
    max-height: 85%;
    overflow-y: auto;
    padding: 20px 30px;
    position: relative;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 10px;
    margin-bottom: 20px;
  }
  .modal-header h2 {
    font-size: 20px;
    color: #5a509b;
  }
  .modal-close {
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
    border: none;
    background: none;
  }
  .modal-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 12px 20px;
  }
  .modal-grid strong {
    font-weight: 600;
    color: #374151;
  }
  .modal-grid span,
  .modal-grid input,
  .modal-grid select,
  .modal-grid textarea {
    color: #1f2937;
  }
  .modal input,
  .modal select,
  .modal textarea {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    margin-bottom: 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
  }
  .modal button {
    background: #5a509b;
    color: #fff;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  .modal img,
  .modal iframe {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 5px;
  }
</style>

<div class="report-container">
  <div class="report-header">
    <h1>Kelola Laporan Insiden</h1>
    <button onclick="downloadReport()">‚¨áÔ∏è Unduh CSV</button>
  </div>

  <div class="filter-bar">
    <select id="filterJenis">
      <option value="">Filter Jenis Insiden</option>
      <option value="Kekerasan Seksual">Kekerasan Seksual</option>
      <option value="Bulying">Bulying</option>
      <option value="Kekerasan Digital">Kekerasan Digital</option>
      <option value="Kekerasan Fisik">Kekerasan Fisik</option>
    </select>
    <select id="filterStatus">
      <option value="">Filter Status</option>
      <option value="Selesai">Selesai</option>
      <option value="Terjadwal">Terjadwal</option>
      <option value="Dibatalkan">Dibatalkan</option>
    </select>
    <input type="search" id="filterSearch" placeholder="Cari Pelapor..." />
    <button onclick="applyFilter()">Terapkan Filter</button>
  </div>

  <div class="report-table-section">
    <table class="report-table" id="reportTable">
      <thead>
        <tr>
          <th>ID Laporan</th>
          <th>Pelapor</th>
          <th>Tanggal Laporan</th>
          <th>Jenis Insiden</th>
          <th>AI Analisis</th>
          <th>Tempat Kejadian</th>
          <th>Deskripsi</th>
          <th>Link Pelaporan</th>
          <th>Lampiran</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        {% for lap in laporan_list %}
        <tr
          data-pk="{{ lap.pk }}"
          data-id="{{ lap.kode }}"
          data-pelapor="{% if lap.is_anonim %}Anonim{% elif lap.pelapor %}{{ lap.pelapor.nama_lengkap }}{% else %}Anonim{% endif %}"
          data-tanggal-laporan="{{ lap.created_at|date:'d/m/Y' }}"
          data-jenis="{{ lap.jenis }}"
          data-tempat-kejadian="{{ lap.lokasi }}"
          data-link-pelaporan="{{ lap.link_pelaporan }}"
          data-deskripsi="{{ lap.deskripsi|default:'-' }}"
          data-lampiran=""
          data-status="{{ lap.status }}"
        >
          <td>{{ lap.kode }}</td>
          <td>{% if lap.is_anonim %}Anonim{% elif lap.pelapor %}{{ lap.pelapor.nama_lengkap }}{% else %}Anonim{% endif %}</td>
          <td>{{ lap.created_at|date:'d/m/Y' }}</td>
          <td>{{ lap.jenis }}</td>
          <td>
            {% if lap.ai_analyzed %}
              {% if lap.ai_urgency %}
                <span class="urgency-badge urgency-{{ lap.ai_urgency }}">
                  {% if lap.ai_urgency == 'darurat' %}üö® DARURAT
                  {% elif lap.ai_urgency == 'tinggi' %}‚ö†Ô∏è Tinggi
                  {% elif lap.ai_urgency == 'sedang' %}üìå Sedang
                  {% else %}‚úÖ Rendah{% endif %}
                </span>
              {% endif %}
              {% if lap.ai_kategori %}
                <div class="ai-kategori">{{ lap.ai_kategori }}</div>
              {% endif %}
            {% else %}
              <span style="color: #9ca3af; font-size: 11px;">-</span>
            {% endif %}
          </td>
          <td>{{ lap.lokasi }}</td>
          <td>{{ lap.deskripsi|truncatechars:80 }}</td>
          <td>{% if lap.link_pelaporan %}<a href="{{ lap.link_pelaporan }}" target="_blank">Lihat</a>{% else %}-{% endif %}</td>
          <td>
            {% if lap.evidences.all %}
              {% for ev in lap.evidences.all %}
                {% if forloop.first %}
                  <a href="{{ ev.file.url }}" download>{{ ev.file.name }}</a>
                {% endif %}
              {% endfor %}
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            <span class="status-badge {% if lap.status == 'ditutup' %}status-selesai{% elif lap.status == 'ditolak' %}status-dibatalkan{% else %}status-terjadwal{% endif %}">
              {{ lap.get_status_display_with_emoji }}
            </span>
            <div style="font-size: 11px; color: #6B7280; margin-top: 4px;">
              <strong>Tahap {{ lap.get_tahap_resmi }}:</strong> {{ lap.get_tahap_label }}
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <a class="btn-view" href="{% url 'admin-detail-laporan' report_id=lap.pk %}" title="Detail">üëÅÔ∏è</a>
              <a class="btn-edit" href="{% url 'edit-laporan' report_id=lap.pk %}" title="Edit">‚úèÔ∏è</a>
              <form method="POST" action="{% url 'delete-laporan' report_id=lap.pk %}" style="display:inline">{% csrf_token %}
                <button class="btn-delete" type="button" onclick="confirmDelete(this)" title="Hapus">üóëÔ∏è</button>
              </form>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="10" style="text-align:center;">Tidak ada laporan ditemukan.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="modalDetailOverlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Detail Laporan</h2>
      <button class="modal-close" onclick="closeDetailModal()">√ó</button>
    </div>
    <div id="modalDetailContent"></div>
  </div>
</div>

<div class="modal-overlay" id="modalEditOverlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Edit Laporan</h2>
      <button class="modal-close" onclick="closeEditModal()">√ó</button>
    </div>
    <div id="modalEditContent"></div>
  </div>
</div>

<div class="modal-overlay" id="modalDeleteOverlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Hapus Laporan</h2>
      <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
    </div>
    <p>
      Apakah anda yakin ingin menghapus laporan ini? Tindakan tidak bisa
      dibatalkan.
    </p>
    <div style="text-align: right; margin-top: 15px">
      <button
        onclick="deleteReportConfirm()"
        style="margin-right: 10px; background: #dc2626"
      >
        Hapus
      </button>
      <button onclick="closeDeleteModal()">Batal</button>
    </div>
  </div>
</div>

<script>
  let deleteTarget = null;

  // Preview lampiran
  function getPreviewHTML(file) {
    const ext = file.split(".").pop().toLowerCase();
    if (["jpg", "jpeg", "png", "gif"].includes(ext)) {
      return `<img src="/media/${file}">`;
    } else if (ext === "pdf") {
      return `<iframe src="/media/${file}" style="height:400px;"></iframe>`;
    } else {
      return `<a href="/media/${file}" download>${file}</a>`;
    }
  }

  // Status label mapping
  const statusLabelMap = {
    'diterima': 'Laporan Diterima',
    'verifikasi_awal': 'Verifikasi Awal',
    'wawancara_pelapor': 'Wawancara Pelapor',
    'wawancara_terlapor': 'Wawancara Terlapor',
    'pengumpulan_bukti': 'Pengumpulan Bukti',
    'rapat_pemutusan': 'Rapat Pemutusan Kasus',
    'rekomendasi': 'Rekomendasi',
    'pelaksanaan': 'Pelaksanaan',
    'ditutup': 'Kasus Ditutup',
    'ditolak': 'Ditolak',
  };

  function statusClassFor(token) {
    if (token === 'ditutup') return 'status-selesai';
    if (token === 'ditolak') return 'status-dibatalkan';
    return 'status-terjadwal';
  }

  // Helper to read CSRF cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Detail Modal
  function getRowData(button) {
    return button.closest("tr").dataset;
  }
  function openDetailModal(button) {
    const data = getRowData(button);
    const content = `<div class="modal-grid">
    <strong>ID Laporan:</strong><span>${data.id}</span>
    <strong>Pelapor:</strong><span>${data.pelapor}</span>
    <strong>Tanggal Laporan:</strong><span>${data.tanggalLaporan}</span>
    <strong>Jenis Insiden:</strong><span>${data.jenis}</span>
    <strong>Tempat Kejadian:</strong><span>${data.tempatKejadian || '-'}</span>
    <strong>Deskripsi:</strong><span>${data.deskripsi}</span>
    <strong>Link Pelaporan:</strong><span>${data.linkPelaporan ? `<a href="${data.linkPelaporan}" target="_blank">Lihat</a>` : '-'}</span>
    <strong>Lampiran:</strong><span>${getPreviewHTML(data.lampiran)}</span>
    <strong>Status:</strong><span class="status-badge ${
      data.status == "Selesai"
        ? "status-selesai"
        : data.status == "Terjadwal"
        ? "status-terjadwal"
        : "status-dibatalkan"
    }">${data.status}</span>
  </div>`;
    document.getElementById("modalDetailContent").innerHTML = content;
    document.getElementById("modalDetailOverlay").style.display = "flex";
  }
  function closeDetailModal() {
    document.getElementById("modalDetailOverlay").style.display = "none";
  }

  // Edit Modal
  function openEditModal(button) {
    const data = getRowData(button);
    const row = button.closest("tr");
    const currentStatus = data.status || '';
    const html = `<div class="modal-grid">
    <strong>ID Laporan:</strong><span>${data.id}</span>
    <strong>Pelapor:</strong><span>${data.pelapor}</span>
    <strong>Tanggal Laporan:</strong><span>${data.tanggalLaporan}</span>
    <strong>Jenis Insiden:</strong><span>${data.jenis}</span>
    <strong>Tempat Kejadian:</strong><span>${data.tempatKejadian || ''}</span>
    <strong>Deskripsi:</strong><span>${data.deskripsi}</span>
    <strong>Link Pelaporan:</strong><span>${data.linkPelaporan ? `<a href="${data.linkPelaporan}" target="_blank">Lihat</a>` : ''}</span>
    <strong>Lampiran:</strong><span>${getPreviewHTML(data.lampiran)}</span>
    <strong>Status:</strong>
    <select id="editStatus">
      <option value="diterima" ${currentStatus == "diterima" ? "selected" : ""}>${statusLabelMap['diterima']}</option>
      <option value="verifikasi_awal" ${currentStatus == "verifikasi_awal" ? "selected" : ""}>${statusLabelMap['verifikasi_awal']}</option>
      <option value="wawancara_pelapor" ${currentStatus == "wawancara_pelapor" ? "selected" : ""}>${statusLabelMap['wawancara_pelapor']}</option>
      <option value="wawancara_terlapor" ${currentStatus == "wawancara_terlapor" ? "selected" : ""}>${statusLabelMap['wawancara_terlapor']}</option>
      <option value="pengumpulan_bukti" ${currentStatus == "pengumpulan_bukti" ? "selected" : ""}>${statusLabelMap['pengumpulan_bukti']}</option>
      <option value="rapat_pemutusan" ${currentStatus == "rapat_pemutusan" ? "selected" : ""}>${statusLabelMap['rapat_pemutusan']}</option>
      <option value="rekomendasi" ${currentStatus == "rekomendasi" ? "selected" : ""}>${statusLabelMap['rekomendasi']}</option>
      <option value="pelaksanaan" ${currentStatus == "pelaksanaan" ? "selected" : ""}>${statusLabelMap['pelaksanaan']}</option>
      <option value="ditutup" ${currentStatus == "ditutup" ? "selected" : ""}>${statusLabelMap['ditutup']}</option>
      <option value="ditolak" ${currentStatus == "ditolak" ? "selected" : ""}>${statusLabelMap['ditolak']}</option>
    </select>
    <strong>Catatan (opsional):</strong><textarea id="editCatatan" placeholder="Catatan atau alasan penolakan"></textarea>
    <strong>Rekomendasi (opsional):</strong><textarea id="editRekomendasi" placeholder="Rekomendasi tindak lanjut jika ada"></textarea>
  </div>
  <div style="text-align:right; margin-top:15px;">
    <button id="modalSaveBtn">üíæ Simpan</button>
  </div>`;
    document.getElementById("modalEditContent").innerHTML = html;
    document.getElementById("modalEditOverlay").style.display = "flex";

    document.getElementById('modalSaveBtn').addEventListener('click', function(){
      saveEditAjax(row.dataset.pk, row);
    });
  }
  function closeEditModal() {
    document.getElementById("modalEditOverlay").style.display = "none";
  }
  async function saveEditAjax(pk, row) {
    const status = document.getElementById("editStatus").value;
    const catatan = document.getElementById("editCatatan").value || '';
    const rekomendasi = document.getElementById("editRekomendasi").value || '';
    const url = `/dashboard/laporan/edit/${pk}/`;
    const fd = new FormData();
    fd.append('status', status);
    fd.append('catatan', catatan);
    fd.append('rekomendasi', rekomendasi);

    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: fd,
      });
      if (!resp.ok) throw new Error('Request failed');

      // Update the row dataset and visible badge
      row.dataset.status = status;
      const label = statusLabelMap[status] || status;
      const cls = statusClassFor(status);
      row.cells[8].innerHTML = `<span class="status-badge ${cls}">${label}</span>`;

      closeEditModal();
    } catch (err) {
      alert('Gagal menyimpan perubahan: ' + err.message);
    }
  }

  // Delete
  function confirmDelete(button) {
    deleteTarget = button.closest("tr");
    document.getElementById("modalDeleteOverlay").style.display = "flex";
  }
  function closeDeleteModal() {
    document.getElementById("modalDeleteOverlay").style.display = "none";
    deleteTarget = null;
  }
  function deleteReportConfirm() {
    if (deleteTarget) {
      // submit the POST form inside the selected row
      const form = deleteTarget.querySelector('form');
      if (form) {
        form.submit();
      } else {
        // fallback: just remove row
        deleteTarget.remove();
      }
      closeDeleteModal();
    }
  }

  // Filter
  function applyFilter() {
    const jenis = document.getElementById("filterJenis").value.toLowerCase();
    const status = document.getElementById("filterStatus").value.toLowerCase();
    const search = document.getElementById("filterSearch").value.toLowerCase();
    document.querySelectorAll("#tableBody tr").forEach((row) => {
      const r = row.dataset;
      if (
        (!jenis || r.jenis.toLowerCase() == jenis) &&
        (!status || r.status.toLowerCase() == status) &&
        (!search || r.pelapor.toLowerCase().includes(search))
      ) {
        row.style.display = "";
      } else row.style.display = "none";
    });
  }

  // Download CSV
  function downloadReport() {
    const rows = document.querySelectorAll("#tableBody tr");
    let csv =
      "ID Laporan,Pelapor,Tanggal Laporan,Jenis Insiden,Tempat Kejadian,Deskripsi,Link Pelaporan,Lampiran,Status\n";
    rows.forEach((row) => {
      if (row.style.display != "none") {
        const r = row.dataset;
        csv += `${r.id},${r.pelapor},${r.tanggalLaporan},${r.jenis},${r.tempatKejadian || ''},"${r.deskripsi}",${r.linkPelaporan || ''},${r.lampiran},${r.status}\n`;
      }
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "laporan.csv";
    a.click();
    URL.revokeObjectURL(url);
  }
</script>
{% endblock %}
