{% extends 'base.html' %} {% load static %} {% block title %}Kelola Laporan
{%endblock %} {% block content %}
<style>
  body {
    font-family: "Poppins", sans-serif;
    background: #f9fafb;
    margin: 0;
    padding: 0;
  }
  .report-container {
    padding: 30px;
  }
  .report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }
  .report-header h1 {
    font-size: 26px;
    color: #1f2937;
  }
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    background: #fff;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
  }
  .filter-bar select,
  .filter-bar input[type="search"] {
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    flex-grow: 1;
    max-width: 200px;
  }
  .filter-bar button {
    background-color: #5a509b;
    color: #fff;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.3s;
  }
  .filter-bar button:hover {
    background-color: #4338ca;
  }
  .report-table-section {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    overflow-x: auto;
  }
  .report-table {
    width: 100%;
    border-collapse: collapse;
  }
  .report-table th,
  .report-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #f3f4f6;
    text-align: left;
  }
  .report-table th {
    background: #eef2ff;
    color: #4f46e5;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
  }
  .status-badge {
    padding: 5px 10px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }
  .status-selesai {
    background-color: #d1fae5;
    color: #065f46;
  }
  .status-terjadwal {
    background-color: #fef3c7;
    color: #b45309;
  }
  .status-dibatalkan {
    background-color: #fee2e2;
    color: #991b1b;
  }
  .action-buttons {
    display: flex;
    gap: 8px;
  }
  .action-buttons button {
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: 0.3s;
  }
  .btn-view {
    background: #eef2ff;
    color: #4f46e5;
  }
  .btn-view:hover {
    background: #c7d2fe;
  }
  .btn-edit {
    background: #d1fae5;
    color: #065f46;
  }
  .btn-edit:hover {
    background: #a7f3d0;
  }
  .btn-delete {
    background: #fee2e2;
    color: #991b1b;
  }
  .btn-delete:hover {
    background: #fecaca;
  }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    justify-content: center;
    align-items: center;
  }
  .modal {
    background: #fff;
    border-radius: 12px;
    width: 700px;
    max-width: 95%;
    max-height: 85%;
    overflow-y: auto;
    padding: 20px 30px;
    position: relative;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 10px;
    margin-bottom: 20px;
  }
  .modal-header h2 {
    font-size: 20px;
    color: #5a509b;
  }
  .modal-close {
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
    border: none;
    background: none;
  }
  .modal-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 12px 20px;
  }
  .modal-grid strong {
    font-weight: 600;
    color: #374151;
  }
  .modal-grid span,
  .modal-grid input,
  .modal-grid select,
  .modal-grid textarea {
    color: #1f2937;
  }
  .modal input,
  .modal select,
  .modal textarea {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    margin-bottom: 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
  }
  .modal button {
    background: #5a509b;
    color: #fff;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  .modal img,
  .modal iframe {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 5px;
  }
</style>

<div class="report-container">
  <div class="report-header">
    <h1>Kelola Laporan Insiden</h1>
    <button onclick="downloadReport()">‚¨áÔ∏è Unduh CSV</button>
  </div>

  <div class="filter-bar">
    <select id="filterJenis">
      <option value="">Filter Jenis Insiden</option>
      <option value="Kekerasan Seksual">Kekerasan Seksual</option>
      <option value="Bulying">Bulying</option>
      <option value="Kekerasan Digital">Kekerasan Digital</option>
      <option value="Kekerasan Fisik">Kekerasan Fisik</option>
    </select>
    <select id="filterStatus">
      <option value="">Filter Status</option>
      <option value="Selesai">Selesai</option>
      <option value="Terjadwal">Terjadwal</option>
      <option value="Dibatalkan">Dibatalkan</option>
    </select>
    <input type="search" id="filterSearch" placeholder="Cari Pelapor..." />
    <button onclick="applyFilter()">Terapkan Filter</button>
  </div>

  <div class="report-table-section">
    <table class="report-table" id="reportTable">
      <thead>
        <tr>
          <th>ID Laporan</th>
          <th>Pelapor</th>
          <th>Tanggal Laporan</th>
          <th>Jenis Insiden</th>
          <th>Tanggal Kejadian</th>
          <th>Deskripsi</th>
          <th>Lampiran</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr
          data-id="#L001"
          data-pelapor="Ani Rahmawati"
          data-tanggal-laporan="01/11/2024"
          data-jenis="Bulying"
          data-tanggal-kejadian="31/10/2024"
          data-deskripsi="-."
          data-lampiran="foto1.jpg"
          data-status="Selesai"
        >
          <td>#L001</td>
          <td>Ani Rahmawati</td>
          <td>01/11/2024</td>
          <td>Bulying </td>
          <td>31/10/2024</td>
          <td>-.</td>
          <td><a href="/media/foto1.jpg" download>foto1.jpg</a></td>
          <td><span class="status-badge status-selesai">Selesai</span></td>
          <td>
            <div class="action-buttons">
              <button class="btn-view" onclick="openDetailModal(this)">
                üëÅÔ∏è Detail
              </button>
              <button class="btn-edit" onclick="openEditModal(this)">
                ‚úèÔ∏è Edit
              </button>
              <button class="btn-delete" onclick="confirmDelete(this)">
                üóëÔ∏è Hapus
              </button>
            </div>
          </td>
        </tr>
        <tr
          data-id="#L002"
          data-pelapor="Budi Santoso"
          data-tanggal-laporan="02/11/2024"
          data-jenis="Kekerasan Fisik"
          data-tanggal-kejadian="02/11/2024"
          data-deskripsi="Pemukulan."
          data-lampiran="lampiran2.pdf"
          data-status="Terjadwal"
        >
          <td>#L002</td>
          <td>Budi Santoso</td>
          <td>02/11/2024</td>
          <td>Kekerasan Fisik</td>
          <td>02/11/2024</td>
          <td>Pemukulan.</td>
          <td><a href="/media/lampiran2.pdf" download>lampiran2.pdf</a></td>
          <td><span class="status-badge status-terjadwal">Terjadwal</span></td>
          <td>
            <div class="action-buttons">
              <button class="btn-view" onclick="openDetailModal(this)">
                üëÅÔ∏è Detail
              </button>
              <button class="btn-edit" onclick="openEditModal(this)">
                ‚úèÔ∏è Edit
              </button>
              <button class="btn-delete" onclick="confirmDelete(this)">
                üóëÔ∏è Hapus
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="modalDetailOverlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Detail Laporan</h2>
      <button class="modal-close" onclick="closeDetailModal()">√ó</button>
    </div>
    <div id="modalDetailContent"></div>
  </div>
</div>

<div class="modal-overlay" id="modalEditOverlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Edit Laporan</h2>
      <button class="modal-close" onclick="closeEditModal()">√ó</button>
    </div>
    <div id="modalEditContent"></div>
  </div>
</div>

<div class="modal-overlay" id="modalDeleteOverlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Hapus Laporan</h2>
      <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
    </div>
    <p>
      Apakah anda yakin ingin menghapus laporan ini? Tindakan tidak bisa
      dibatalkan.
    </p>
    <div style="text-align: right; margin-top: 15px">
      <button
        onclick="deleteReportConfirm()"
        style="margin-right: 10px; background: #dc2626"
      >
        Hapus
      </button>
      <button onclick="closeDeleteModal()">Batal</button>
    </div>
  </div>
</div>

<script>
  let deleteTarget = null;

  // Preview lampiran
  function getPreviewHTML(file) {
    const ext = file.split(".").pop().toLowerCase();
    if (["jpg", "jpeg", "png", "gif"].includes(ext)) {
      return `<img src="/media/${file}">`;
    } else if (ext === "pdf") {
      return `<iframe src="/media/${file}" style="height:400px;"></iframe>`;
    } else {
      return `<a href="/media/${file}" download>${file}</a>`;
    }
  }

  // Detail Modal
  function getRowData(button) {
    return button.closest("tr").dataset;
  }
  function openDetailModal(button) {
    const data = getRowData(button);
    const content = `<div class="modal-grid">
    <strong>ID Laporan:</strong><span>${data.id}</span>
    <strong>Pelapor:</strong><span>${data.pelapor}</span>
    <strong>Tanggal Laporan:</strong><span>${data.tanggalLaporan}</span>
    <strong>Jenis Insiden:</strong><span>${data.jenis}</span>
    <strong>Tanggal Kejadian:</strong><span>${data.tanggalKejadian}</span>
    <strong>Deskripsi:</strong><span>${data.deskripsi}</span>
    <strong>Lampiran:</strong><span>${getPreviewHTML(data.lampiran)}</span>
    <strong>Status:</strong><span class="status-badge ${
      data.status == "Selesai"
        ? "status-selesai"
        : data.status == "Terjadwal"
        ? "status-terjadwal"
        : "status-dibatalkan"
    }">${data.status}</span>
  </div>`;
    document.getElementById("modalDetailContent").innerHTML = content;
    document.getElementById("modalDetailOverlay").style.display = "flex";
  }
  function closeDetailModal() {
    document.getElementById("modalDetailOverlay").style.display = "none";
  }

  // Edit Modal
  function openEditModal(button) {
    const data = getRowData(button);
    const row = button.closest("tr");
    const html = `<div class="modal-grid">
    <strong>ID Laporan:</strong><span>${data.id}</span>
    <strong>Pelapor:</strong><span>${data.pelapor}</span>
    <strong>Tanggal Laporan:</strong><span>${data.tanggalLaporan}</span>
    <strong>Jenis Insiden:</strong><span>${data.jenis}</span>
    <strong>Tanggal Kejadian:</strong><span>${data.tanggalKejadian}</span>
    <strong>Deskripsi:</strong><span>${data.deskripsi}</span>
    <strong>Lampiran:</strong><span>${getPreviewHTML(data.lampiran)}</span>
    <strong>Status:</strong>
    <select id="editStatus">
      <option value="Selesai" ${
        data.status == "Selesai" ? "selected" : ""
      }>Selesai</option>
      <option value="Terjadwal" ${
        data.status == "Terjadwal" ? "selected" : ""
      }>Terjadwal</option>
      <option value="Dibatalkan" ${
        data.status == "Dibatalkan" ? "selected" : ""
      }>Dibatalkan</option>
    </select>
  </div>
  <div style="text-align:right; margin-top:15px;">
    <button onclick="saveEdit('${data.id}', row)">üíæ Simpan</button>
  </div>`;
    document.getElementById("modalEditContent").innerHTML = html;
    document.getElementById("modalEditOverlay").style.display = "flex";
  }
  function closeEditModal() {
    document.getElementById("modalEditOverlay").style.display = "none";
  }
  function saveEdit(id, row) {
    const status = document.getElementById("editStatus").value;
    row.dataset.status = status;
    row.cells[7].innerHTML = `<span class="status-badge ${
      status == "Selesai"
        ? "status-selesai"
        : status == "Terjadwal"
        ? "status-terjadwal"
        : "status-dibatalkan"
    }">${status}</span>`;
    closeEditModal();
  }

  // Delete
  function confirmDelete(button) {
    deleteTarget = button.closest("tr");
    document.getElementById("modalDeleteOverlay").style.display = "flex";
  }
  function closeDeleteModal() {
    document.getElementById("modalDeleteOverlay").style.display = "none";
    deleteTarget = null;
  }
  function deleteReportConfirm() {
    if (deleteTarget) {
      deleteTarget.remove();
      closeDeleteModal();
    }
  }

  // Filter
  function applyFilter() {
    const jenis = document.getElementById("filterJenis").value.toLowerCase();
    const status = document.getElementById("filterStatus").value.toLowerCase();
    const search = document.getElementById("filterSearch").value.toLowerCase();
    document.querySelectorAll("#tableBody tr").forEach((row) => {
      const r = row.dataset;
      if (
        (!jenis || r.jenis.toLowerCase() == jenis) &&
        (!status || r.status.toLowerCase() == status) &&
        (!search || r.pelapor.toLowerCase().includes(search))
      ) {
        row.style.display = "";
      } else row.style.display = "none";
    });
  }

  // Download CSV
  function downloadReport() {
    const rows = document.querySelectorAll("#tableBody tr");
    let csv =
      "ID Laporan,Pelapor,Tanggal Laporan,Jenis Insiden,Tanggal Kejadian,Deskripsi,Lampiran,Status\n";
    rows.forEach((row) => {
      if (row.style.display != "none") {
        const r = row.dataset;
        csv += `${r.id},${r.pelapor},${r.tanggalLaporan},${r.jenis},${r.tanggalKejadian},"${r.deskripsi}",${r.lampiran},${r.status}\n`;
      }
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "laporan.csv";
    a.click();
    URL.revokeObjectURL(url);
  }
</script>
{% endblock %}
