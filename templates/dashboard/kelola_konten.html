{% extends 'base.html' %} {% load static %} {% block title %}Kelola Konten
{%endblock %} {% block content %}

<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
  /* ===== core styles (kept clean & consistent) ===== */
  :root {
    --blue: #5a509b;
    --muted: #6b7280;
    --card: #fff;
    --bg: #f9fafb;
  }
  body {
    font-family: "Poppins", sans-serif;
    margin: 0;
    padding: 20px;
    background: var(--bg);
    color: #111827;
  }

  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 18px;
  }
  .filter-group {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  select,
  .search-input {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: #fff;
    font-size: 14px;
  }
  .search-wrapper {
    position: relative;
  }
  .search-wrapper i {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    pointer-events: none;
  }
  .search-input {
    padding-left: 34px;
    width: 260px;
  }

  .btn-add {
    background: var(--blue);
    color: #fff;
    padding: 9px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    gap: 8px;
    align-items: center;
    font-weight: 600;
  }
  .btn-add:hover {
    background: #5a509b;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 14px rgba(2, 6, 23, 0.06);
  }
  th,
  td {
    padding: 12px 14px;
    text-align: left;
    border-bottom: 1px solid #eef2f7;
    font-size: 14px;
    vertical-align: middle;
  }
  th {
    background: var(--blue);
    color: #fff;
    font-weight: 600;
  }

  .aksi {
    display: flex;
    gap: 6px;
    justify-content: flex-start;
  }
  .icon-btn {
    width: 34px;
    height: 34px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    font-size: 16px;
    transition: all 0.2s;
  }
  .icon-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .icon-btn.view {
    border-color: #5a509b;
  }
  .icon-btn.view:hover {
    background: #5a509b;
    border-color: #5a509b;
  }
  .icon-btn.edit {
    border-color: #f59e0b;
  }
  .icon-btn.edit:hover {
    background: #f59e0b;
    border-color: #f59e0b;
  }
  .icon-btn.del {
    border-color: #ef4444;
  }
  .icon-btn.del:hover {
    background: #ef4444;
    border-color: #ef4444;
  }

  .badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }
  .badge-success {
    background: #dcfce7;
    color: #16a34a;
  }
  .badge-draft {
    background: #f3f4f6;
    color: #6b7280;
  }
  .badge-warning {
    background: #fef3c7;
    color: #d97706;
  }
  .badge-kesadaran {
    background: #dbeafe;
    color: #2563eb;
  }
  .badge-pencegahan {
    background: #dcfce7;
    color: #16a34a;
  }
  .badge-dukungan {
    background: #fce7f3;
    color: #db2777;
  }
  .badge-informasi {
    background: #f3e8ff;
    color: #9333ea;
  }

  /* modal fullscreen */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(15, 23, 42, 0.65);
    backdrop-filter: blur(5px);
    justify-content: center;
    align-items: center;
    padding: 24px;
    overflow-y: auto;
  }
  .modal.fullscreen {
    align-items: flex-start;
  }

  .modal-panel {
    background: var(--card);
    border-radius: 14px;
    width: 100%;
    max-width: 1100px;
    box-shadow: 0 18px 50px rgba(2, 6, 23, 0.35);
    overflow: hidden;
    animation: slideUp 0.32s ease;
  }
  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-close {
    position: absolute;
    right: 12px;
    top: 12px;
    z-index: 10;
    width: 40px;
    height: 40px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    background: #fff;
    box-shadow: 0 6px 18px rgba(2, 6, 23, 0.08);
  }
  .modal-close:hover {
    background: #f3f4f6;
  }

  /* view article layout - fullscreen style */
  .view-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 0;
  }
  .view-left {
    padding: 28px 32px;
    max-height: 78vh;
    overflow: auto;
  }
  .view-right {
    background: #f8fafc;
    padding: 20px 24px;
    border-left: 1px solid #eef2f7;
    max-height: 78vh;
    overflow: auto;
  }

  .view-title {
    font-size: 28px;
    color: #1e3a8a;
    margin: 0 0 8px;
    font-weight: 700;
  }
  .view-meta {
    color: var(--muted);
    margin-bottom: 12px;
    font-size: 14px;
  }
  .view-media {
    margin: 14px 0;
  }
  .view-media img,
  .view-media iframe {
    width: 100%;
    border-radius: 8px;
  }

  .view-body p {
    color: #374151;
    line-height: 1.8;
    margin-bottom: 12px;
    text-align: justify;
    white-space: pre-wrap;
  }

  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .info-item {
    background: #fff;
    border: 1px solid #eef2f7;
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    color: #374151;
  }
  .info-label {
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 6px;
    display: block;
  }
  .info-value {
    font-weight: 600;
  }

  /* form modal */
  .form-body {
    padding: 20px 24px;
    max-height: 78vh;
    overflow: auto;
  }
  .form-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .form-col {
    flex: 1 1 280px;
    min-width: 180px;
  }
  .form-group {
    margin-bottom: 12px;
  }
  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: #374151;
  }
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 14px;
    background: #fff;
  }
  .form-group textarea {
    min-height: 140px;
    resize: vertical;
  }
  
  /* Quill Editor Styles */
  #editor-container {
    min-height: 300px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
  }
  .ql-toolbar {
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
    background: #f9fafb;
  }
  .ql-container {
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
    font-size: 14px;
    font-family: "Poppins", sans-serif;
  }
  
  .img-preview {
    width: 140px;
    height: 84px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #e6e9ee;
  }

  .form-actions {
    padding: 12px 24px;
    border-top: 1px solid #f1f5f9;
    text-align: right;
  }
  .btn-save {
    background: var(--blue);
    color: #fff;
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
  }

  @media (max-width: 900px) {
    .view-grid {
      grid-template-columns: 1fr;
    }
    .view-right {
      border-left: none;
      border-top: 1px solid #eef2f7;
    }
  }
</style>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="filter-group">
    <label>Kategori:</label>
    <select id="filterKategori">
      <option value="semua">Semua</option>
      <option value="Artikel">Artikel</option>
      <option value="Berita">Berita</option>
      <option value="Panduan">Panduan</option>
    </select>

    <label>Status:</label>
    <select id="filterStatus">
      <option value="semua">Semua</option>
      <option value="Draft">Draft</option>
      <option value="Publik">Publik</option>
      <option value="Arsip">Arsip</option>
    </select>

    <div class="search-wrapper">
      <i>üîç</i>
      <input
        id="searchInput"
        class="search-input"
        placeholder="Cari judul atau isi..."
      />
    </div>
  </div>

  <button class="btn-add" id="btnAdd">Ôºã Tambah Konten</button>
</div>

<!-- TABLE -->
<table>
  <thead>
    <tr>
      <th>Judul</th>
      <th>Tanggal</th>
      <th>Penulis</th>
      <th>Kategori</th>
      <th>Status</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody id="kontenBody">
    {% for konten in konten_list %}
    <tr data-konten-id="{{ konten.id }}">
      <td style="max-width: 300px;">
        <strong>{{ konten.judul }}</strong>
        <p style="margin: 4px 0 0; color: #6b7280; font-size: 13px;">
          {{ konten.deskripsi|truncatewords:15 }}
          {% if konten.gambar %}<span style="color:#10b981;">üñºÔ∏è</span>{% endif %}
          {% if konten.media_url %}<span style="color:#3b82f6;">üîó</span>{% endif %}
        </p>
      </td>
      <td>{{ konten.created_at|date:"d M Y" }}</td>
      <td>{{ konten.penulis }}</td>
      <td><span class="badge badge-{{ konten.kategori }}">{{ konten.get_kategori_display }}</span></td>
      <td>
        {% if konten.scheduled_date %}
        <span class="badge badge-warning">Terjadwal {{ konten.scheduled_date|date:"d M Y H:i" }}</span>
        {% elif konten.is_published %}
        <span class="badge badge-success">Aktif</span>
        {% else %}
        <span class="badge badge-draft">Draft</span>
        {% endif %}
      </td>
      <td>
        <div class="aksi">
          <button class="icon-btn edit" 
            data-id="{{ konten.id }}"
            onclick="editKonten(this)"
            title="Edit">
            ‚úèÔ∏è
          </button>
          <form action="{% url 'toggle-konten' konten.id %}" method="POST" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="icon-btn view" title="{% if konten.is_published %}Sembunyikan{% else %}Publikasikan{% endif %}">
              {% if konten.is_published %}üîí{% else %}üëÅÔ∏è{% endif %}
            </button>
          </form>
          <button class="icon-btn del" onclick="confirmDelete({{ konten.id }}, '{{ konten.judul|escapejs }}')" title="Hapus">
            üóëÔ∏è
          </button>
        </div>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
        Belum ada konten. Klik "Tambah Konten" untuk membuat konten baru.
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- VIEW (FULLSCREEN) -->
<div id="modalLihat" class="modal" aria-hidden="true">
  <div
    class="modal-panel modal-panel-view modal-panel modal-panel"
    style="position: relative"
  >
    <button class="modal-close" id="closeView" title="Tutup">‚úï</button>
    <div class="modal-panel modal-panel-inner modal-panel">
      <div class="view-grid">
        <div class="view-left">
          <h1 id="lihatJudul" class="view-title">Judul</h1>
          <div id="lihatMeta" class="view-meta">
            Tanggal ‚Ä¢ Penulis ‚Ä¢ Kategori
          </div>
          <div id="viewMedia" class="view-media"></div>
          <div id="lihatIsi" class="view-body"></div>
        </div>

        <aside class="view-right">
          <h3 style="margin-top: 0; color: #1e3a8a">Informasi</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Kategori</span>
              <div id="infoKategori" class="info-value">‚Äî</div>
            </div>
            <div class="info-item">
              <span class="info-label">Penulis</span>
              <div id="infoPenulis" class="info-value">‚Äî</div>
            </div>
            <div class="info-item">
              <span class="info-label">Status</span>
              <div id="infoStatus" class="info-value">‚Äî</div>
            </div>
            <div class="info-item">
              <span class="info-label">Tanggal Publikasi</span>
              <div id="infoTanggal" class="info-value">‚Äî</div>
            </div>
            <div class="info-item" style="grid-column: 1/-1">
              <span class="info-label">Terakhir Diperbarui</span>
              <div id="infoUpdated" class="info-value">‚Äî</div>
            </div>
            <div class="info-item" style="grid-column: 1/-1">
              <span class="info-label">Media</span>
              <div id="infoMediaLink" class="info-value">
                <a id="infoMediaAnchor" href="#" target="_blank" rel="noopener"
                  >‚Äî</a
                >
              </div>
            </div>
          </div>

          <div style="margin-top: 18px; text-align: right">
            <button class="icon-btn edit" id="viewEditBtn" title="Edit">
              ‚úèÔ∏è
            </button>
            <button class="icon-btn del" id="viewDeleteBtn" title="Hapus">
              üóëÔ∏è
            </button>
          </div>
        </aside>
      </div>
    </div>
  </div>
</div>

<!-- FORM (ADD / EDIT) -->
<div id="modalForm" class="modal" aria-hidden="true">
  <div class="modal-panel" style="position: relative">
    <button class="modal-close" id="closeForm" title="Tutup">‚úï</button>

    <div class="form-body">
      <h2 id="formTitle">Tambah Konten</h2>
      
      <form method="POST" action="{% url 'kelola-konten' %}" id="kontenForm" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_konten" id="formAction">
        <input type="hidden" name="konten_id" id="kontenId">

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="judulInput">Judul *</label>
            <input
              id="judulInput"
              name="judul"
              type="text"
              placeholder="Masukkan judul..."
              required
            />
          </div>

          <div class="form-group">
            <label for="penulisInput">Penulis</label>
            <input
              id="penulisInput"
              name="penulis"
              type="text"
              placeholder="Nama penulis..."
              value="Tim Ruang Dengar"
            />
          </div>

          <div class="form-group">
            <label for="kategoriInput">Kategori *</label>
            <select id="kategoriInput" name="kategori" required>
              <option value="kesadaran">Kesadaran</option>
              <option value="pencegahan">Pencegahan</option>
              <option value="dukungan">Dukungan</option>
              <option value="informasi">Informasi</option>
            </select>
          </div>

          <div class="form-group">
            <label for="deskripsiInput">Deskripsi Singkat *</label>
            <textarea id="deskripsiInput" name="deskripsi" rows="3" placeholder="Deskripsi untuk card artikel..." required></textarea>
          </div>

          <div class="form-group">
            <label for="tagsInput">Tags (Kata Kunci)</label>
            <input
              id="tagsInput"
              name="tags"
              type="text"
              placeholder="Pisahkan dengan koma: bullying,kekerasan fisik,pelecehan"
            />
            <small style="color:#666; font-size:12px; display: block; margin-top: 5px;">
              üè∑Ô∏è Tags untuk rekomendasi artikel. Contoh: bullying,mental health,kekerasan seksual
            </small>
          </div>

          <div class="form-group">
            <label for="gambarInput">Upload Gambar Artikel</label>
            <input type="file" id="gambarInput" name="gambar" accept="image/*" onchange="previewImage(event)" 
              style="padding: 8px; border: 2px dashed #ddd; border-radius: 8px; cursor: pointer;">
            <div id="imagePreviewContainer" style="margin-top: 10px; display: none;">
              <img id="previewImg" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #ddd;">
              <button type="button" onclick="removeImage()" style="margin-top: 8px; background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;">üóëÔ∏è Hapus Gambar</button>
            </div>
            <input type="hidden" id="currentGambar" name="current_gambar">
            <small style="color:#666; font-size:12px; display: block; margin-top: 5px;">Format: JPG, PNG, GIF. Max 10MB</small>
          </div>

          <div class="form-group">
            <label for="mediaUrlInput">Link Media Tambahan (Opsional)</label>
            <input type="url" id="mediaUrlInput" name="media_url" placeholder="https://youtube.com/... atau link PDF"
              style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 100%;" onchange="previewMediaUrl(event)">
            <div id="mediaPreviewContainer" style="margin-top: 10px; display: none; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
              <div id="mediaPreviewContent"></div>
              <button type="button" onclick="removeMediaUrl()" style="margin-top: 8px; background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Hapus Link</button>
            </div>
            <small style="color:#666; font-size:12px; display: block; margin-top: 5px;">
              üìπ YouTube ‚Ä¢ üìÑ PDF ‚Ä¢ üîó Link lainnya
            </small>
          </div>

          <div class="form-group">
            <label for="scheduledInput">Jadwalkan Publikasi (Opsional)</label>
            <input id="scheduledInput" name="scheduled_date" type="datetime-local" placeholder="Kosongkan untuk publish langsung">
            <small style="color:#666; font-size:12px;">Konten akan otomatis publish pada tanggal ini</small>
          </div>
        </div>

        <div class="form-col" style="min-width: 220px; display: none;">
          <div class="form-group">
            <label for="urlInput"
              >URL Media (gambar / pdf / youtube / link)</label
            >
            <input id="urlInput" type="url" placeholder="https://..." />
          </div>

          <div
            style="
              display: flex;
              gap: 12px;
              align-items: center;
              margin-bottom: 12px;
            "
          >
            <img id="previewThumb" class="img-preview" src="" alt="Preview" />
            <div style="font-size: 13px; color: var(--muted)">
              Preview otomatis sesuai tipe media
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="isiInput">Isi Konten Lengkap *</label>
        <div id="editor-container"></div>
        <textarea id="isiInput" name="konten" style="display:none;"></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-save" id="btnSave">üíæ Simpan</button>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display:none;">
  <div class="modal-panel" style="max-width: 400px;">
    <h3 style="margin-top:0;">Konfirmasi Hapus</h3>
    <p id="deleteMessage">Yakin ingin menghapus konten ini?</p>
    <div class="form-actions">
      <button onclick="closeDeleteModal()" class="btn-cancel" style="background:#ccc;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;">Batal</button>
      <form id="deleteForm" method="POST" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn-save" style="background:#dc2626;">Hapus</button>
      </form>
    </div>
  </div>
</div>

<script>
  // Hapus localStorage logic, gunakan data dari Django backend
  
  function escapeHtml(s = "") {
    return String(s).replace(
      /[&<>"']/g,
      (c) =>
        ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[c])
    );
  }

  // Image preview functions
  function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        alert('Ukuran file terlalu besar! Maksimal 10MB');
        event.target.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('previewImg').src = e.target.result;
        document.getElementById('imagePreviewContainer').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  }

  function removeImage() {
    document.getElementById('gambarInput').value = '';
    document.getElementById('imagePreviewContainer').style.display = 'none';
    document.getElementById('previewImg').src = '';
    document.getElementById('currentGambar').value = '';
  }

  // Media URL preview functions
  function previewMediaUrl(event) {
    const url = event.target.value;
    const container = document.getElementById('mediaPreviewContainer');
    const content = document.getElementById('mediaPreviewContent');
    
    if (!url) {
      container.style.display = 'none';
      return;
    }

    let preview = '';
    
    // YouTube
    if (url.includes('youtube.com/watch?v=') || url.includes('youtu.be/')) {
      const videoId = url.includes('youtu.be/') 
        ? url.split('youtu.be/')[1].split('?')[0]
        : url.split('v=')[1].split('&')[0];
      preview = `
        <div style="text-align: center;">
          <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" 
            style="max-width: 100%; border-radius: 8px; cursor: pointer;" 
            onclick="window.open('${url}', '_blank')"
            alt="YouTube Thumbnail">
          <p style="margin-top: 8px; color: #666; font-size: 13px;">üìπ Video YouTube</p>
        </div>
      `;
    }
    // PDF
    else if (url.toLowerCase().endsWith('.pdf')) {
      preview = `
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px;">üìÑ</div>
          <p style="margin-top: 8px; color: #666; font-size: 13px;">Dokumen PDF</p>
          <a href="${url}" target="_blank" style="color: #5a67d8; text-decoration: underline; font-size: 12px;">Buka PDF</a>
        </div>
      `;
    }
    // Google Drive
    else if (url.includes('drive.google.com')) {
      preview = `
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px;">‚òÅÔ∏è</div>
          <p style="margin-top: 8px; color: #666; font-size: 13px;">Google Drive</p>
          <a href="${url}" target="_blank" style="color: #5a67d8; text-decoration: underline; font-size: 12px;">Buka Link</a>
        </div>
      `;
    }
    // General link
    else {
      preview = `
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px;">üîó</div>
          <p style="margin-top: 8px; color: #666; font-size: 13px;">Link Eksternal</p>
          <a href="${url}" target="_blank" style="color: #5a67d8; text-decoration: underline; font-size: 12px; word-break: break-all;">${url.substring(0, 50)}...</a>
        </div>
      `;
    }
    
    content.innerHTML = preview;
    container.style.display = 'block';
  }

  function removeMediaUrl() {
    document.getElementById('mediaUrlInput').value = '';
    document.getElementById('mediaPreviewContainer').style.display = 'none';
    document.getElementById('mediaPreviewContent').innerHTML = '';
  }

  // ---------- modal helpers ----------
  const modalForm = document.getElementById("modalForm");
  const modalLihat = document.getElementById("modalLihat");

  function showModal(el) {
    el.style.display = "flex";
    el.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
    const focusable = el.querySelector("input, button, select, textarea");
    if (focusable) focusable.focus();
  }
  function hideModal(el) {
    el.style.display = "none";
    el.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "auto";
    if (el === modalForm) {
      editingId = null;
      f_title.value = "";
      f_author.value = "";
      f_date.value = new Date().toISOString().split("T")[0];
      f_url.value = "";
      f_preview.src = "";
      f_kategori.value = "Artikel";
      f_status.value = "Draft";
      f_isi.value = "";
    }
  }

  document
    .querySelectorAll(".modal-close")
    .forEach((btn) =>
      btn.addEventListener("click", () => hideModal(btn.closest(".modal")))
    );
  document.querySelectorAll(".modal").forEach((ov) =>
    ov.addEventListener("click", (e) => {
      if (e.target === ov) hideModal(ov);
    })
  );

  function detectMedia(url) {
    if (!url) return "";
    if (url.match(/\.(jpeg|jpg|png|gif|webp)$/i))
      return `<img src="${url}" alt="media">`;
    if (url.match(/youtube\.com\/watch\?v=([^\s&]+)/))
      return `<iframe src="https:....." frameborder="0" allowfullscreen style="height:200px;width:100%;border-radius:8px;"></iframe>`;
    return `<a href="${url}" target="_blank">${url}</a>`;
  }

  // ---------- form controls ----------
  const f_title = document.getElementById("judulInput");
  const f_author = document.getElementById("penulisInput");
  const f_date = document.getElementById("tanggalInput");
  const f_url = document.getElementById("urlInput");
  const f_preview = document.getElementById("previewThumb");
  const f_kategori = document.getElementById("kategoriInput");
  const f_status = document.getElementById("statusInput");
  const f_isi = document.getElementById("isiInput");

  f_url.addEventListener("input", () => (f_preview.src = f_url.value));

  // Modal functions
  function showModal(modal) {
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
  }

  function hideModal(modal) {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }

  // Close modal buttons
  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => hideModal(btn.closest('.modal')));
  });

  // Function to edit konten - load from API endpoint
  function editKonten(button) {
    const id = button.dataset.id;
    console.log('Edit konten ID:', id);
    
    // Show loading in modal
    document.getElementById('formTitle').innerText = 'Loading...';
    document.getElementById('modalForm').style.display = 'flex';
    document.getElementById('modalForm').setAttribute('aria-hidden', 'false');
    
    // Fetch konten data from API
    fetch(`/api/konten/${id}/`)
      .then(response => {
        console.log('API Response status:', response.status);
        if (!response.ok) throw new Error('Failed to load konten');
        return response.json();
      })
      .then(data => {
        console.log('Konten data loaded:', data);
        // Set form values
        document.getElementById('formTitle').innerText = 'Edit Konten';
        document.getElementById('formAction').value = 'edit_konten';
        document.getElementById('judulInput').value = data.judul || '';
        document.getElementById('kategoriInput').value = data.kategori || '';
        document.getElementById('deskripsiInput').value = data.deskripsi || '';
        document.getElementById('penulisInput').value = data.penulis || '';
        document.getElementById('tagsInput').value = data.tags || '';
        document.getElementById('kontenForm').action = `/dashboard/konten/${id}/edit/`;
        
        // Load konten HTML to Quill editor
        if (quill && data.konten) {
          quill.root.innerHTML = data.konten;
        }
        
        // Show current image if exists
        if (data.gambar) {
          document.getElementById('previewImg').src = data.gambar;
          document.getElementById('imagePreviewContainer').style.display = 'block';
          document.getElementById('currentGambar').value = data.gambar;
        } else {
          document.getElementById('imagePreviewContainer').style.display = 'none';
          document.getElementById('currentGambar').value = '';
        }
        
        // Show current media URL if exists
        if (data.media_url) {
          document.getElementById('mediaUrlInput').value = data.media_url;
          previewMediaUrl({target: {value: data.media_url}});
        } else {
          document.getElementById('mediaPreviewContainer').style.display = 'none';
        }
      })
      .catch(error => {
        console.error('Error loading konten:', error);
        alert('Gagal memuat data konten. Silakan coba lagi.');
        document.getElementById('modalForm').style.display = 'none';
      });
  }

  function confirmDelete(id, judul) {
    document.getElementById('deleteMessage').innerText = `Yakin ingin menghapus konten "${judul}"?`;
    document.getElementById('deleteForm').action = `/dashboard/konten/${id}/delete/`;
    document.getElementById('deleteModal').style.display = 'flex';
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
  }

  // Close modal buttons - executed immediately
  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => hideModal(btn.closest('.modal')));
  });
</script>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  // Initialize everything when DOM is ready
  var quill;
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Initializing...');
    
    // Initialize Quill editor
    quill = new Quill('#editor-container', {
      theme: 'snow',
      placeholder: 'Tulis isi konten lengkap...',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'indent': '-1'}, { 'indent': '+1' }],
          ['blockquote', 'code-block'],
          ['link'],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'align': [] }],
          ['clean']
        ]
      }
    });
    
    console.log('Quill initialized');

    // Setup form submit handler
    var kontenForm = document.getElementById('kontenForm');
    console.log('Form element:', kontenForm);
    
    kontenForm.addEventListener('submit', function(e) {
      e.preventDefault(); // Prevent default untuk handle dengan AJAX
      
      console.log('Form submit triggered');
      
      var content = quill.root.innerHTML;
      var text = quill.getText().trim();
      
      // Validasi konten tidak boleh kosong
      if (text.length === 0) {
        alert('‚ùå Isi konten lengkap tidak boleh kosong!');
        return false;
      }
      
      // Set konten ke hidden textarea
      document.getElementById('isiInput').value = content;
      
      console.log('Content set, submitting form...');
      console.log('Konten length:', content.length);
      
      // Submit form dengan FormData untuk handle file upload
      var formData = new FormData(this);
      var formAction = this.getAttribute('action');
      console.log('Form action URL:', formAction);
      
      // Disable button sementara
      var btnSave = document.getElementById('btnSave');
      var originalText = btnSave.innerHTML;
      btnSave.disabled = true;
      btnSave.innerHTML = '‚è≥ Menyimpan...';
      
      fetch(formAction, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (response.redirected) {
          // Redirect otomatis ke halaman kelola konten (sudah ada Django messages)
          window.location.href = response.url;
        } else if (response.ok) {
          // Reload halaman untuk tampilkan Django messages
          window.location.reload();
        } else {
          throw new Error('Server error: ' + response.status);
        }
      })
      .catch(error => {
        console.error('Error submitting form:', error);
        alert('‚ùå Gagal menyimpan konten: ' + error.message);
        btnSave.disabled = false;
        btnSave.innerHTML = originalText;
      });
      
      return false;
    });
    
    console.log('Form submit handler attached');
    
    // Setup button Add handler
    document.getElementById('btnAdd').addEventListener('click', function() {
      console.log('Opening add konten modal');
      document.getElementById('formTitle').innerText = 'Tambah Konten';
      kontenForm.reset();
      kontenForm.action = '{% url "kelola-konten" %}';
      document.getElementById('formAction').value = 'add_konten';
      document.getElementById('imagePreviewContainer').style.display = 'none';
      document.getElementById('currentGambar').value = '';
      document.getElementById('previewImg').src = '';
      document.getElementById('mediaPreviewContainer').style.display = 'none';
      document.getElementById('mediaPreviewContent').innerHTML = '';
      // Reset Quill editor
      if (quill) {
        quill.setText('');
      }
      // Show modal
      document.getElementById('modalForm').style.display = 'flex';
      document.getElementById('modalForm').setAttribute('aria-hidden', 'false');
      console.log('Modal should be visible now');
    });
    
    // Close form modal
    document.getElementById('closeForm').addEventListener('click', function() {
      document.getElementById('modalForm').style.display = 'none';
      document.getElementById('modalForm').setAttribute('aria-hidden', 'true');
    });
    
    // Close modal when clicking outside
    document.getElementById('modalForm').addEventListener('click', function(e) {
      if (e.target.id === 'modalForm') {
        document.getElementById('modalForm').style.display = 'none';
        document.getElementById('modalForm').setAttribute('aria-hidden', 'true');
      }
    });
    
    console.log('All event handlers attached successfully');
  });
</script>

{% endblock %}
